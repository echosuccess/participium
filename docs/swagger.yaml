openapi: 3.0.3
info:
  title: Participium API - Citizen Registration & Municipality Administration
  description: |
    API for citizen registration, authentication (PT01) and municipality user management (PT02).
    Uses session-based authentication with HTTP-only cookies.
    
    ## Municipality User Management
    System administrators can create, update and delete internal municipality user accounts.
    The system must have at least one administrator account pre-configured in the database.
    
    Available municipality roles:
    - PUBLIC_RELATIONS: Public relations officer for citizen communication
    - ADMINISTRATOR: Administrative staff for report management 
    - TECHNICAL_OFFICE: Technical staff for resolving reported issues
  version: 1.1.0
  contact:
    name: Municipality of Turin
    email: support@participium.torino.it

servers:
  - url: http://localhost:4000/api
    description: Development server
  - url: https://participium.torino.it/api
    description: Production server

tags:
  - name: Authentication
    description: Login, logout and session management operations
  - name: Citizens
    description: Citizen registration operations
  - name: Administration
    description: Municipality user management operations (create, update, delete)

paths:
  /session:
    post:
      tags:
        - Authentication
      summary: Login to the system
      description: |
        Authenticate a user (citizen or municipality staff) and create a session.
        A session cookie (connect.sid) will be set in the response headers.
        The cookie is HTTP-only and secure (in production).
        Uses email and password for authentication via Passport.js local strategy.
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            example:
              email: mario.rossi@example.com
              password: SecurePass123!
      responses:
        '200':
          description: |
            Login successful. Session cookie set in Set-Cookie header.
            Client must include credentials in subsequent requests.
          headers:
            Set-Cookie:
              description: Session cookie
              schema:
                type: string
                example: connect.sid=s%3Axxx.yyy; Path=/; HttpOnly
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '400':
          description: Already logged in
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "BadRequest"
                message: "Already logged in"
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Unauthorized"
                message: "Invalid username or password"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "InternalServerError"
                message: "An unexpected error occurred"

  /session/current:
    get:
      tags:
        - Authentication
      summary: Get current session info
      description: |
        Returns information about the current authenticated user.
        Returns 200 OK with user information when authenticated.
        Returns 401 Unauthorized when no valid session exists.
        No explicit authentication required - endpoint checks session validity.
      operationId: getSession
      responses:
        '200':
          description: User is authenticated - session info retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SessionResponse'
              example:
                authenticated: true
                user:
                  firstName: Mario
                  lastName: Rossi
                  email: mario.rossi@example.com
                  role: CITIZEN
                  telegramUsername: null
                  emailNotificationsEnabled: true
        '401':
          description: User is not authenticated - no valid session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Unauthorized"
                message: "No valid session found"

    delete:
      tags:
        - Authentication
      summary: Logout from the system
      description: |
        Invalidate the current session and clear the session cookie.
        Requires an active session.
      operationId: logout
      security:
        - SessionAuth: []
      responses:
        '200':
          description: Logout successful. Session cookie invalidated.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Logged out"
        '400':
          description: Already logged out / No active session
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "BadRequest"
                message: "Already logged out"
        '500':
          description: Logout failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "InternalServerError"
                message: "Logout failed"

  /citizen/signup:
    post:
      tags:
        - Citizens
      summary: Register a new citizen
      description: |
        Self-service registration for citizens. No authentication required.
        Email must be unique in the system.
      operationId: registerCitizen
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CitizenRegistrationRequest'
            example:
              firstName: Mario
              lastName: Rossi
              email: mario.rossi@example.com
              password: SecurePass123!
      responses:
        '201':
          description: Registration successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CitizenRegistrationResponse'
        '400':
          description: Missing required fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "BadRequest"
                message: "Missing required fields: email, password"
        '409':
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Conflict"
                message: "Email already in use"
        '500':
          description: Unable to create user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "InternalServerError"
                message: "Unable to create user"

  /admin/municipality-users:
    post:
      tags:
        - Administration
      summary: Create a new municipality user
      description: |
        Create a new internal municipality user account. Only administrators can perform this operation.
        Email must be unique in the system.
      operationId: createMunicipalityUser
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MunicipalityUserRequest'
            example:
              firstName: Giuseppe
              lastName: Verdi
              email: giuseppe.verdi@comune.torino.it
              password: AdminPass123!
              role: PUBLIC_RELATIONS
      responses:
        '201':
          description: Municipality user created successfully. The password is hashed server-side and no sensitive fields (password/salt) are returned in the response.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MunicipalityUserResponse'
        '400':
          description: Missing required fields or invalid data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "BadRequest"
                message: "Missing required fields: firstName, lastName, email, password, role"
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Unauthorized"
                message: "Authentication required"
        '403':
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Forbidden"
                message: "Administrator privileges required"
        '409':
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Conflict"
                message: "Email already in use"
        '500':
          description: Unable to create user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "InternalServerError"
                message: "Unable to create municipality user"

    get:
      tags:
        - Administration
      summary: List all municipality users
      description: |
        Retrieve a complete list of all municipality users (excluding citizens). 
        Returns all internal staff accounts including public relations officers, administrators, and technical office staff.
        Only administrators can perform this operation.
        
        The response includes basic information for each user:
        - User ID, name, email, and role
        - No sensitive information like passwords is returned
      operationId: listMunicipalityUsers
      security:
        - SessionAuth: []
      responses:
        '200':
          description: List of municipality users retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/MunicipalityUserResponse'
              example:
                - id: 123
                  firstName: "Giuseppe"
                  lastName: "Verdi"
                  email: "giuseppe.verdi@comune.torino.it"
                  role: "PUBLIC_RELATIONS"
                - id: 456
                  firstName: "Maria"
                  lastName: "Rossi"
                  email: "maria.rossi@comune.torino.it"
                  role: "ADMINISTRATOR"
                - id: 789
                  firstName: "Franco"
                  lastName: "Bianchi"
                  email: "franco.bianchi@comune.torino.it"
                  role: "TECHNICAL_OFFICE"
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Unauthorized"
                message: "Authentication required"
        '403':
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Forbidden"
                message: "Administrator privileges required"
        '500':
          description: Unable to retrieve users
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "InternalServerError"
                message: "Failed to retrieve users"

  /admin/municipality-users/{userId}:
    get:
      tags:
        - Administration
      summary: Get municipality user details
      description: |
        Retrieve detailed information about a specific municipality user.
        Only administrators can perform this operation.
      operationId: getMunicipalityUser
      security:
        - SessionAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          description: ID of the municipality user
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Municipality user details retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MunicipalityUserResponse'
        '400':
          description: Invalid user ID parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "BadRequest"
                message: "Invalid user ID format"
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Unauthorized"
                message: "Authentication required"
        '403':
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Forbidden"
                message: "Administrator privileges required"
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "NotFound"
                message: "Municipality user not found"
        '500':
          description: Unable to retrieve user details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "InternalServerError"
                message: "Failed to retrieve user"

    put:
      tags:
        - Administration
      summary: Update municipality user
      description: |
        Update information for a specific municipality user.
        Only administrators can perform this operation.
        This endpoint supports partial updates: provide at least one of the updatable fields (firstName, lastName, email, password, role). Fields not present will remain unchanged.
      operationId: updateMunicipalityUser
      security:
        - SessionAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          description: ID of the municipality user to update
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MunicipalityUserUpdateRequest'
            example:
              email: giuseppe.verdi@comune.torino.it
      responses:
        '200':
          description: Municipality user updated successfully. If a password was provided it is hashed server-side; no sensitive fields are returned.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MunicipalityUserResponse'
        '400':
          description: Invalid input data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                invalidUserId:
                  summary: Invalid user ID parameter
                  value:
                    error: "BadRequest"
                    message: "Invalid user ID format"
                missingFields:
                  summary: Missing update fields
                  value:
                    error: "BadRequest"
                    message: "Provide at least one field to update: firstName, lastName, email, password, or role"
                invalidRole:
                  summary: Invalid role value
                  value:
                    error: "BadRequest"
                    message: "Invalid role. Allowed: PUBLIC_RELATIONS, ADMINISTRATOR, TECHNICAL_OFFICE"
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Unauthorized"
                message: "Authentication required"
        '403':
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Forbidden"
                message: "Administrator privileges required"
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "NotFound"
                message: "Municipality user not found"
        '409':
          description: Email already in use by another user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Conflict"
                message: "Email already in use"
        '500':
          description: Unable to update user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "InternalServerError"
                message: "Failed to update user"

    delete:
      tags:
        - Administration
      summary: Delete municipality user
      description: |
        Delete a municipality user account. This action is irreversible.
        Only administrators can perform this operation.
      operationId: deleteMunicipalityUser
      security:
        - SessionAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          description: ID of the municipality user to delete
          schema:
            type: integer
            format: int64
      responses:
        '204':
          description: Municipality user deleted successfully
        '400':
          description: Invalid user ID parameter
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "BadRequest"
                message: "Invalid user ID format"
        '401':
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Unauthorized"
                message: "Authentication required"
        '403':
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "Forbidden"
                message: "Administrator privileges required"
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "NotFound"
                message: "Municipality user not found"
        '500':
          description: Unable to delete user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: "InternalServerError"
                message: "Failed to delete user"

components:
  securitySchemes:
    SessionAuth:
      type: apiKey
      in: cookie
      name: connect.sid
      description: |
        Session-based authentication using HTTP-only cookies with Passport.js.
        The session cookie is automatically sent by the browser with each request.
        Frontend must use 'credentials: include' in fetch/axios requests.

  schemas:
    CitizenRegistrationRequest:
      type: object
      required:
        - firstName
        - lastName
        - email
        - password
      properties:
        firstName:
          type: string
          minLength: 1
          maxLength: 50
          description: Citizen's first name
          example: Mario
        lastName:
          type: string
          minLength: 1
          maxLength: 50
          description: Citizen's last name
          example: Rossi
        email:
          type: string
          format: email
          maxLength: 100
          description: Valid email address (must be unique)
          example: mario.rossi@example.com
        password:
          type: string
          minLength: 8
          maxLength: 100
          format: password
          description: Password (minimum 8 characters)
          example: SecurePass123!

    CitizenRegistrationResponse:
      type: object
      properties:
        firstName:
          type: string
          example: Mario
        lastName:
          type: string
          example: Rossi
        email:
          type: string
          example: mario.rossi@example.com
        role:
          type: string
          enum: [CITIZEN]
          example: CITIZEN
        telegramUsername:
          type: string
          nullable: true
          description: Telegram username for bot notifications
          example: null
        emailNotificationsEnabled:
          type: boolean
          description: Whether email notifications are enabled
          example: true

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          description: User's email address
          example: mario.rossi@example.com
        password:
          type: string
          format: password
          description: Password
          example: SecurePass123!

    LoginResponse:
      type: object
      properties:
        message:
          type: string
          example: "Login successful"
        user:
          $ref: '#/components/schemas/UserInfo'

    SessionResponse:
      type: object
      required:
        - authenticated
      properties:
        authenticated:
          type: boolean
          description: Whether the user is authenticated
          example: true
        user:
          allOf:
            - $ref: '#/components/schemas/UserInfo'
          description: User information (only present when authenticated is true)
          nullable: true

    UserInfo:
      type: object
      properties:
        firstName:
          type: string
          example: Mario
        lastName:
          type: string
          example: Rossi
        email:
          type: string
          example: mario.rossi@example.com
        role:
          type: string
          enum:
            - CITIZEN
            - PUBLIC_RELATIONS
            - ADMINISTRATOR
            - TECHNICAL_OFFICE
          description: User role in the system
          example: CITIZEN
        telegramUsername:
          type: string
          nullable: true
          description: Telegram username for bot notifications
          example: null
        emailNotificationsEnabled:
          type: boolean
          description: Whether email notifications are enabled
          example: true

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error type (BadRequest, Unauthorized, Conflict, InternalServerError)
          example: "BadRequest"
        message:
          type: string
          description: Human-readable error message
          example: "Missing required fields: email, password"

    MunicipalityUserRequest:
      type: object
      required:
        - firstName
        - lastName
        - email
        - password
        - role
      properties:
        firstName:
          type: string
          minLength: 1
          maxLength: 50
          description: Municipality user's first name
          example: Giuseppe
        lastName:
          type: string
          minLength: 1
          maxLength: 50
          description: Municipality user's last name
          example: Verdi
        email:
          type: string
          format: email
          maxLength: 100
          description: Valid email address (must be unique)
          example: giuseppe.verdi@comune.torino.it
        password:
          type: string
          minLength: 8
          maxLength: 100
          format: password
          description: Password (minimum 8 characters)
          example: AdminPass123!
        role:
          type: string
          enum:
            - PUBLIC_RELATIONS
            - ADMINISTRATOR
            - TECHNICAL_OFFICE
          description: Role assigned to the municipality user
          example: PUBLIC_RELATIONS

    MunicipalityUserUpdateRequest:
      type: object
      description: |
        Partial municipality user update. At least one of the fields must be present in the body.
        Fields not present will be left unchanged. Password, if provided, will be hashed server-side.
      properties:
        firstName:
          type: string
          minLength: 1
          maxLength: 50
          description: Municipality user's first name
          example: Giuseppe
        lastName:
          type: string
          minLength: 1
          maxLength: 50
          description: Municipality user's last name
          example: Verdi
        email:
          type: string
          format: email
          maxLength: 100
          description: Valid email address (must be unique)
          example: giuseppe.verdi@comune.torino.it
        password:
          type: string
          minLength: 8
          maxLength: 100
          format: password
          description: New password (minimum 8 characters). If provided, it will be hashed server-side and not returned in the response.
          example: NewPassword123!
        role:
          type: string
          enum:
            - PUBLIC_RELATIONS
            - ADMINISTRATOR
            - TECHNICAL_OFFICE
          description: Role assigned to the municipality user
          example: ADMINISTRATOR

    MunicipalityUserResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Unique identifier for the user
          example: 123
        firstName:
          type: string
          example: Giuseppe
        lastName:
          type: string
          example: Verdi
        email:
          type: string
          example: giuseppe.verdi@comune.torino.it
        role:
          type: string
          enum:
            - PUBLIC_RELATIONS
            - ADMINISTRATOR
            - TECHNICAL_OFFICE
          example: PUBLIC_RELATIONS

# Security requirements for protected endpoints
security:
  - SessionAuth: []
