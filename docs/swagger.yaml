openapi: 3.0.3
info:
  title: Participium API - Citizen Registration & Municipality Administration
  description: |
    API for citizen registration, authentication (PT01), municipality user management (PT02) and municipality users role assignment (PT03).
    Uses session-based authentication with HTTP-only cookies.

    ## Municipality User Management
    System administrators can create, update and delete internal municipality user accounts.
    The system must have at least one administrator account pre-configured in the database.

    **Role Categories:**

    **MUNICIPALITY_ROLES** (all internal municipality staff):
    - ADMINISTRATOR: System administrator with full privileges
    - PUBLIC_RELATIONS: Public relations officer (only role that can approve/reject reports)
    - CULTURE_EVENTS_TOURISM_SPORTS: Culture, events, tourism and sports
    - LOCAL_PUBLIC_SERVICES: Local public services
    - EDUCATION_SERVICES: Education services
    - PUBLIC_RESIDENTIAL_HOUSING: Public/residential housing services
    - INFORMATION_SYSTEMS: Information systems/IT
    - MUNICIPAL_BUILDING_MAINTENANCE: Municipal building maintenance
    - PRIVATE_BUILDINGS: Private buildings oversight
    - INFRASTRUCTURES: Road, bridges and general infrastructures
    - GREENSPACES_AND_ANIMAL_PROTECTION: Parks, green areas and animal protection
    - WASTE_MANAGEMENT: Waste collection and management
    - ROAD_MAINTENANCE: Road maintenance
    - CIVIL_PROTECTION: Civil protection and emergency coordination

    **TECHNICAL_ROLES** (municipality technical staff only, subset of MUNICIPALITY_ROLES):
    - CULTURE_EVENTS_TOURISM_SPORTS through CIVIL_PROTECTION (excludes ADMINISTRATOR and PUBLIC_RELATIONS)

    **TECHNICAL_AND_EXTERNAL_ROLES** (technical staff + external maintainers):
    - All TECHNICAL_ROLES + EXTERNAL_MAINTAINER (for shared operations like viewing assigned reports)
    
    **External roles:**
    - EXTERNAL_MAINTAINER: External company maintainer with platform access for specialized interventions
  version: 1.1.0
  contact:
    name: Municipality of Turin
    email: support@participium.torino.it

servers:
  - url: http://localhost:4000/api
    description: Development server
  - url: https://participium.torino.it/api
    description: Production server

tags:
  - name: Authentication
    description: Login, logout and session management operations
  - name: Citizens
    description: Citizen registration operations
  - name: Administration
    description: Municipality user management operations (create, update, delete)
  - name: Reports
    description: Create and retrieve geolocated reports submitted by citizens

paths:
  /session:
    post:
      tags:
        - Authentication
      summary: Login to the system
      description: |
        Authenticate a user (citizen or municipality staff) and create a session.
        A session cookie (connect.sid) will be set in the response headers.
        The cookie is HTTP-only and secure (in production).
        Uses email and password for authentication via Passport.js local strategy.
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
            example:
              email: mario.rossi@example.com
              password: SecurePass123!
      responses:
        "200":
          description: |
            Login successful. Session cookie set in Set-Cookie header.
            Client must include credentials in subsequent requests.
          headers:
            Set-Cookie:
              description: Session cookie
              schema:
                type: string
                example: connect.sid=s%3Axxx.yyy; Path=/; HttpOnly
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "400":
          description: Already logged in
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 400
                error: "BadRequest"
                message: "Already logged in"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Invalid username or password"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "An unexpected error occurred"


  

  /session/current:
    get:
      tags:
        - Authentication
      summary: Get current session info
      description: |
        Returns information about the current authenticated user.
        Returns 200 OK with user information when authenticated.
        Returns 401 Unauthorized when no valid session exists.
        No explicit authentication required - endpoint checks session validity.
      operationId: getSession
      responses:
        "200":
          description: User is authenticated - session info retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionResponse"
              example:
                authenticated: true
                user:
                  firstName: Mario
                  lastName: Rossi
                  email: mario.rossi@example.com
                  role: CITIZEN
                  telegramUsername: null
                  emailNotificationsEnabled: true
        "401":
          description: User is not authenticated - no valid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "No valid session found"

    delete:
      tags:
        - Authentication
      summary: Logout from the system
      description: |
        Invalidate the current session and clear the session cookie.
        Requires an active session.
      operationId: logout
      security:
        - SessionAuth: []
      responses:
        "200":
          description: Logout successful. Session cookie invalidated.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Logged out"
        "400":
          description: Already logged out / No active session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 400
                error: "BadRequest"
                message: "Already logged out"
        "500":
          description: Logout failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "Logout failed"
  
  
  /citizen/signup:
    post:
      tags:
        - Citizens
      summary: Register a new citizen
      description: |
        Self-service registration for citizens.
        **Important:** After successful registration, the user receives an email with a verification code. 
        The account will remain inactive until the code is verified via `POST /citizen/verify`.
      operationId: registerCitizen
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CitizenRegistrationRequest"
            example:
              firstName: Mario
              lastName: Rossi
              email: mario.rossi@example.com
              password: SecurePass123!
      responses:
        "201":
          description: Registration successful. Verification email sent.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CitizenRegistrationResponse"
        "400":
          description: Missing required fields
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 400
                error: "BadRequest"
                message: "Missing required fields: email, password"
        "409":
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 409
                error: "Conflict"
                message: "Email already in use"
        "500":
          description: Unable to create user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "Unable to create user"

  /citizen/verify:
    post:
      tags:
        - Citizens
      summary: Verify citizen email with code
      description: |
        Verify a citizen's email address using the 6-digit code sent via email after registration (`POST /citizen/signup`).
        The code is valid for 30 minutes. Upon successful verification, the account becomes active and usable.
      operationId: verifyCitizenEmail
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/VerifyRequest"
      responses:
        "200":
          description: Email verified successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Email verified successfully"
        "400":
          description: Invalid code or code expired
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 400
                error: "BadRequest"
                message: "Invalid or expired verification code"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Verification failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /citizen/resend-verification:
    post:
      tags:
        - Citizens
      summary: Resend verification code email
      description: |
        Resend a new verification code to a citizen's email address. 
        Use this when the original verification code has expired (after 30 minutes).
        Only works for unverified citizen accounts.
      operationId: resendCitizenVerificationEmail
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
              properties:
                email:
                  type: string
                  format: email
                  example: mario.rossi@example.com
      responses:
        "200":
          description: Verification email sent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Verification email sent successfully"
        "400":
          description: Email already verified or not a citizen account
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 400
                error: "BadRequest"
                message: "Email already verified"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Failed to send email
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /citizen/me:
    get:
      tags:
        - Citizens
      summary: Get current citizen profile
      description: Returns the authenticated citizen's profile and notification settings.
      operationId: getCitizenProfile
      security:
        - SessionAuth: []
      responses:
        "200":
          description: Citizen profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CitizenConfigResponse"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "An unexpected error occurred"

    patch:
      tags:
        - Citizens
      summary: Update citizen profile configuration
      description: Update name, surname, email, password, Telegram username and email notification preference. At least one field must be provided.
      operationId: updateCitizenConfig
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CitizenConfigRequest"
            example:
              email: "mario.updated@example.com"
      responses:
        "200":
          description: Configuration updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CitizenConfigResponse"
        "400":
          description: Invalid input
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 400
                error: "BadRequest"
                message: "At least one field must be provided"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "409":
          description: Email already in use
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 409
                error: "Conflict"
                message: "Email already in use"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 422
                error: "UnprocessableEntity"
                message: "Invalid email format"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "An unexpected error occurred"

  /citizen/me/photo:
    post:
      tags:
        - Citizens
      summary: Upload/update personal photo
      description: Upload a personal profile photo. Accepts `multipart/form-data` with single file field `photo` (jpg/png). Replaces existing photo if present.
      operationId: uploadCitizenPhoto
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                photo:
                  type: string
                  format: binary
            encoding:
              photo:
                contentType: image/jpeg, image/png
      responses:
        "201":
          description: Photo uploaded successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PhotoUploadResponse"
        "400":
          description: Missing file or invalid file type
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 400
                error: "BadRequest"
                message: "Photo file is required"
        "413":
          description: File too large
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 413
                error: "PayloadTooLarge"
                message: "Photo file exceeds the maximum allowed size"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "An unexpected error occurred"
    delete:
      tags:
        - Citizens
      summary: Remove personal photo
      description: Delete the currently stored personal photo for the authenticated citizen.
      operationId: deleteCitizenPhoto
      security:
        - SessionAuth: []
      responses:
        "204":
          description: Photo deleted successfully
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "404":
          description: Photo not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 404
                error: "NotFound"
                message: "Photo not found"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "An unexpected error occurred"

  /admin/municipality-users:
    post:
      tags:
        - Administration
      summary: Create a new municipality user
      description: |
        Create a new internal municipality user account. Only administrators can perform this operation.
        Email must be unique in the system.
      operationId: createMunicipalityUser
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MunicipalityUserRequest"
            example:
              firstName: Giuseppe
              lastName: Verdi
              email: giuseppe.verdi@comune.torino.it
              password: AdminPass123!
              role: LOCAL_PUBLIC_SERVICES
      responses:
        "201":
          description: Municipality user created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MunicipalityUserResponse"
        "400":
          description: Missing required fields or invalid data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 400
                error: "BadRequest"
                message: "Missing required fields: firstName, lastName, email, password, role"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Administrator privileges required"
        "409":
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 409
                error: "Conflict"
                message: "Email already in use"
        "500":
          description: Unable to create user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "Unable to create municipality user"

    get:
      tags:
        - Administration
      summary: List all municipality users
      description: |
        Retrieve a complete list of all municipality users (excluding citizens). 
        Returns all internal staff accounts including public relations officers, administrators, and technical office staff.
        Only administrators can perform this operation.

        The response includes basic information for each user:
        - User ID, name, email, and role
        - No sensitive information like passwords is returned
      operationId: listMunicipalityUsers
      security:
        - SessionAuth: []
      responses:
        "200":
          description: List of municipality users retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MunicipalityUserResponse"
              example:
                - id: 123
                  firstName: "Giuseppe"
                  lastName: "Verdi"
                  email: "giuseppe.verdi@comune.torino.it"
                  role: "LOCAL_PUBLIC_SERVICES"
                - id: 456
                  firstName: "Maria"
                  lastName: "Rossi"
                  email: "maria.rossi@comune.torino.it"
                  role: "ADMINISTRATOR"
                - id: 789
                  firstName: "Franco"
                  lastName: "Bianchi"
                  email: "franco.bianchi@comune.torino.it"
                  role: "ROAD_MAINTENANCE"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Administrator privileges required"
        "500":
          description: Unable to retrieve users
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "Failed to retrieve users"

  /admin/municipality-users/{userId}:
    get:
      tags:
        - Administration
      summary: Get municipality user details
      description: |
        Retrieve detailed information about a specific municipality user.
        Only administrators can perform this operation.
      operationId: getMunicipalityUser
      security:
        - SessionAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          description: ID of the municipality user
          schema:
            type: integer
            format: int64
      responses:
        "200":
          description: Municipality user details retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MunicipalityUserResponse"
        "400":
          description: Invalid user ID parameter
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 400
                error: "BadRequest"
                message: "Invalid user ID format"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Administrator privileges required"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 404
                error: "NotFound"
                message: "Municipality user not found"
        "500":
          description: Unable to retrieve user details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "Failed to retrieve user"

    delete:
      tags:
        - Administration
      summary: Delete municipality user
      description: |
        Delete a municipality user account. This action is irreversible.
        Only administrators can perform this operation.
      operationId: deleteMunicipalityUser
      security:
        - SessionAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          description: ID of the municipality user to delete
          schema:
            type: integer
            format: int64
      responses:
        "204":
          description: Municipality user deleted successfully
        "400":
          description: Invalid user ID parameter
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 400
                error: "BadRequest"
                message: "Invalid user ID format"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Administrator privileges required"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 404
                error: "NotFound"
                message: "Municipality user not found"
        "500":
          description: Unable to delete user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "Failed to delete user"

  /admin/roles:
    get:
      tags:
        - Administration
      summary: List available municipality roles
      description: |
        Returns the list of roles that can be assigned to municipality users. Useful for UI role selection and validation.
      operationId: listMunicipalityRoles
      security:
        - SessionAuth: []
      responses:
        "200":
          description: Array of available roles
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MunicipalityRole"
              example:
                - ADMINISTRATOR
                - PUBLIC_RELATIONS
                - CULTURE_EVENTS_TOURISM_SPORTS
                - LOCAL_PUBLIC_SERVICES
                - EDUCATION_SERVICES
                - PUBLIC_RESIDENTIAL_HOUSING
                - INFORMATION_SYSTEMS
                - MUNICIPAL_BUILDING_MAINTENANCE
                - PRIVATE_BUILDINGS
                - INFRASTRUCTURES
                - GREENSPACES_AND_ANIMAL_PROTECTION
                - WASTE_MANAGEMENT
                - ROAD_MAINTENANCE
                - CIVIL_PROTECTION

        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Administrator privileges required"
        "500":
          description: Unable to retrieve roles
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "Failed to retrieve roles"

  /admin/external-companies:
    post:
      tags:
        - Administration
      summary: Create a new external company
      description: |
        Create a new external company that can potentially be assigned report maintenance tasks.
        Only administrators can perform this operation.
      operationId: createExternalCompany
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - categories
                - platformAccess
              properties:
                name:
                  type: string
                  description: Company name
                  example: "Green Tech Solutions"
                categories:
                  type: array
                  items:
                    $ref: "#/components/schemas/ReportCategory"
                  minItems: 1
                  maxItems: 2
                  description: Report categories this company can handle (max 2)
                  example: ["GREENSPACES", "ROAD_MAINTENANCE"]
                platformAccess:
                  type: boolean
                  description: Whether this company can have maintainer accounts
                  example: true
      responses:
        "201":
          description: External company created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                    example: 1
                  name:
                    type: string
                    example: "Green Tech Solutions"
                  categories:
                    type: array
                    items:
                      $ref: "#/components/schemas/ReportCategory"
                    example: ["GREENSPACES", "ROAD_MAINTENANCE"]
                  platformAccess:
                    type: boolean
                    example: true
        "400":
          description: Invalid input data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                invalidName:
                  value:
                    code: 400
                    error: "BadRequest" 
                    message: "Company name is required"
                invalidCategories:
                  value:
                    code: 400
                    error: "BadRequest"
                    message: "Maximum 2 categories allowed"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Administrator privileges required"
    
    get:
      tags:
        - Administration
      summary: List all external companies
      description: |
        Returns all external companies with their associated maintainer accounts.
        Only administrators can perform this operation.
      operationId: listExternalCompanies
      security:
        - SessionAuth: []
      responses:
        "200":
          description: Array of external companies with maintainers
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: integer
                    name:
                      type: string
                    categories:
                      type: array
                      items:
                        $ref: "#/components/schemas/ReportCategory"
                    platformAccess:
                      type: boolean
                    maintainers:
                      type: array
                      items:
                        type: object
                        properties:
                          id:
                            type: integer
                          firstName:
                            type: string
                          lastName:
                            type: string
                          email:
                            type: string
                          role:
                            type: string
              example:
                - id: 1
                  name: "Green Tech Solutions"
                  categories: ["GREENSPACES", "ROAD_MAINTENANCE"]
                  platformAccess: true
                  maintainers:
                    - id: 101
                      firstName: "Mario"
                      lastName: "Rossi"
                      email: "mario.rossi@greentech.com"
                      role: "EXTERNAL_MAINTAINER"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Administrator privileges required"

  /admin/external-companies/{id}:
    delete:
      tags:
        - Administration
      summary: Delete an external company
      description: |
        Delete an external company by ID. The company must not have any associated maintainers.
        Only administrators can perform this operation.
      operationId: deleteExternalCompany
      security:
        - SessionAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
          description: External company ID to delete
          example: 1
      responses:
        "204":
          description: External company deleted successfully
        "400":
          description: Invalid input or business rule violation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                invalidId:
                  value:
                    code: 400
                    error: "BadRequest"
                    message: "Invalid company ID parameter"
                hasMaintainers:
                  value:
                    code: 400
                    error: "BadRequest"
                    message: "Cannot delete company with existing maintainers. Remove all maintainers first."
                deleteFailed:
                  value:
                    code: 400
                    error: "BadRequest"
                    message: "Failed to delete external company"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Administrator privileges required"
        "404":
          description: External company not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 404
                error: "NotFound"
                message: "External company not found"

  /admin/external-companies/platform-access:
    get:
      tags:
        - Administration
      summary: Get external companies with platform access and their maintainers
      description: |
        Returns external companies that have platform access and can have maintainer accounts created,
        along with their existing maintainer users. Used for dropdown/selection UI and maintainer overview.
      operationId: getExternalCompaniesWithAccess
      security:
        - SessionAuth: []
      responses:
        "200":
          description: Companies with platform access and their maintainers
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: integer
                    name:
                      type: string
                    categories:
                      type: array
                      items:
                        $ref: "#/components/schemas/ReportCategory"
                    platformAccess:
                      type: boolean
                    users:
                      type: array
                      nullable: true
                      items:
                        type: object
                        properties:
                          id:
                            type: integer
                          firstName:
                            type: string
                          lastName:
                            type: string
                          email:
                            type: string
                          role:
                            type: string
                            enum: ["EXTERNAL_MAINTAINER"]
              example:
                - id: 1
                  name: "Green Tech Solutions"
                  categories: ["GREENSPACES", "ROAD_MAINTENANCE"]
                  platformAccess: true
                  users:
                    - id: 10
                      firstName: "Giuseppe"
                      lastName: "Bianchi"
                      email: "giuseppe.bianchi@greentech.com"
                      role: "EXTERNAL_MAINTAINER"
                - id: 2
                  name: "Tech Services Inc"
                  categories: ["INFRASTRUCTURE"]
                  platformAccess: true
                  users: null
        "401":
          description: Not authenticated
        "403":
          description: Insufficient permissions

  /admin/external-maintainers:
    post:
      tags:
        - Administration
      summary: Create an external maintainer account
      description: |
        Create a new external maintainer account linked to a company with platform access.
        Only administrators can perform this operation.
      operationId: createExternalMaintainer
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - firstName
                - lastName
                - email
                - password
                - externalCompanyId
              properties:
                firstName:
                  type: string
                  example: "Mario"
                lastName:
                  type: string
                  example: "Rossi"
                email:
                  type: string
                  format: email
                  example: "mario.rossi@greentech.com"
                password:
                  type: string
                  minLength: 8
                  example: "SecurePass123!"
                externalCompanyId:
                  type: string
                  description: ID of external company (as string for form compatibility)
                  example: "1"
      responses:
        "201":
          description: External maintainer created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  firstName:
                    type: string
                  lastName:
                    type: string
                  email:
                    type: string
                  role:
                    type: string
                  company:
                    type: object
                    properties:
                      id:
                        type: integer
                      name:
                        type: string
                      categories:
                        type: array
                        items:
                          $ref: "#/components/schemas/ReportCategory"
                      platformAccess:
                        type: boolean
              example:
                id: 101
                firstName: "Mario"
                lastName: "Rossi"
                email: "mario.rossi@greentech.com"
                role: "EXTERNAL_MAINTAINER"
                company:
                  id: 1
                  name: "Green Tech Solutions"
                  categories: ["GREENSPACES", "ROAD_MAINTENANCE"]
                  platformAccess: true
        "400":
          description: Invalid input or business rule violation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                emailExists:
                  value:
                    code: 400
                    error: "BadRequest"
                    message: "Email already exists"
                noPlatformAccess:
                  value:
                    code: 400
                    error: "BadRequest"
                    message: "Cannot create maintainer for company without platform access"
                weakPassword:
                  value:
                    code: 400
                    error: "BadRequest"
                    message: "password is required and must be at least 8 characters"
        "401":
          description: Not authenticated
        "403":
          description: Insufficient permissions
        "404":
          description: External company not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 404
                error: "NotFound"
                message: "External company not found"

    get:
      tags:
        - Administration
      summary: List all external maintainers
      description: |
        Retrieve a list of all external maintainers with their company details.
        Only administrators can perform this operation.
      operationId: listExternalMaintainers
      security:
        - SessionAuth: []
      responses:
        "200":
          description: List of external maintainers retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: integer
                    firstName:
                      type: string
                    lastName:
                      type: string
                    email:
                      type: string
                    role:
                      type: string
                    company:
                      type: object
                      properties:
                        id:
                          type: integer
                        name:
                          type: string
                        categories:
                          type: array
                          items:
                            $ref: "#/components/schemas/ReportCategory"
                        platformAccess:
                          type: boolean
              example:
                - id: 101
                  firstName: "Mario"
                  lastName: "Rossi"
                  email: "mario.rossi@greentech.com"
                  role: "EXTERNAL_MAINTAINER"
                  company:
                    id: 1
                    name: "Green Tech Solutions"
                    categories: ["GREENSPACES", "ROAD_MAINTENANCE"]
                    platformAccess: true
                - id: 102
                  firstName: "Laura"
                  lastName: "Bianchi"
                  email: "laura.bianchi@aquafix.com"
                  role: "EXTERNAL_MAINTAINER"
                  company:
                    id: 2
                    name: "Aqua Fix Srl"
                    categories: ["WATER_SUPPLY", "SEWER_SYSTEM"]
                    platformAccess: true
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Administrator privileges required"

  /admin/external-maintainers/{maintainerId}:
    get:
      tags:
        - Administration
      summary: Get external maintainer details
      description: |
        Retrieve details of a specific external maintainer by ID.
        Only administrators can perform this operation.
      operationId: getExternalMaintainer
      security:
        - SessionAuth: []
      parameters:
        - name: maintainerId
          in: path
          required: true
          schema:
            type: integer
          description: External maintainer ID
          example: 101
      responses:
        "200":
          description: External maintainer details retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: integer
                  firstName:
                    type: string
                  lastName:
                    type: string
                  email:
                    type: string
                  role:
                    type: string
                  company:
                    type: object
                    properties:
                      id:
                        type: integer
                      name:
                        type: string
                      categories:
                        type: array
                        items:
                          $ref: "#/components/schemas/ReportCategory"
                      platformAccess:
                        type: boolean
              example:
                id: 101
                firstName: "Mario"
                lastName: "Rossi"
                email: "mario.rossi@greentech.com"
                role: "EXTERNAL_MAINTAINER"
                company:
                  id: 1
                  name: "Green Tech Solutions"
                  categories: ["GREENSPACES", "ROAD_MAINTENANCE"]
                  platformAccess: true
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Administrator privileges required"
        "404":
          description: External maintainer not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 404
                error: "NotFound"
                message: "External maintainer not found"

    delete:
      tags:
        - Administration
      summary: Delete an external maintainer
      description: |
        Delete an external maintainer by ID. The maintainer must not have any assigned reports.
        Only administrators can perform this operation.
      operationId: deleteExternalMaintainer
      security:
        - SessionAuth: []
      parameters:
        - name: maintainerId
          in: path
          required: true
          schema:
            type: integer
          description: External maintainer ID to delete
          example: 101
      responses:
        "204":
          description: External maintainer deleted successfully
        "400":
          description: Invalid input or business rule violation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                invalidId:
                  value:
                    code: 400
                    error: "BadRequest"
                    message: "Invalid maintainer ID format"
                hasAssignedReports:
                  value:
                    code: 400
                    error: "BadRequest"
                    message: "Cannot delete external maintainer with assigned reports"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Administrator privileges required"
        "404":
          description: External maintainer not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 404
                error: "NotFound"
                message: "External maintainer not found"

  /reports:
    post:
      tags:
        - Reports
      summary: Create a new report with geolocation
      description: |
        Create a new citizen report tied to a geographic location within the municipality of Turin.
        Use an interactive map to select the location. Coordinates must be in decimal degrees (WGS84).
        All coordinates must be within Turin municipality boundaries.
      operationId: createReport
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/ReportRequest"
            encoding:
              photos:
                contentType: image/jpeg, image/png
      responses:
        "201":
          description: Report created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  report:
                    $ref: "#/components/schemas/ReportResponse"
              example:
                message: "Report created successfully"
                report:
                  id: 1024
                  title: "Pothole on Via Roma"
                  description: "Large pothole near the pedestrian crossing, causing risk for cyclists."
                  category: ROADS_URBAN_FURNISHINGS
                  latitude: 45.070339
                  longitude: 7.686864
                  status: PENDING_APPROVAL
                  user:
                    id: 201
                    firstName: Mario
                    lastName: Rossi
                    email: mario.rossi@example.com
                    role: CITIZEN
                    telegramUsername: null
                    emailNotificationsEnabled: true
                  assignedOfficer: null
                  messages:
                    - id: 1
                      content: "Initial report created by user"
                      createdAt: "2025-11-11T10:12:34Z"
                      senderId: 201
                  rejectedReason: null
                  photos:
                    - id: 301
                      url: "https://cdn.example.com/reports/1024/photo1.jpg"
                      filename: "photo1.jpg"
                  createdAt: "2025-11-11T10:12:34Z"
                  updatedAt: "2025-11-11T10:12:34Z"
                  
        "400":
          description: Missing required fields
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 400
                error: "BadRequest"
                message: "Missing required fields"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "User not logged in"
        "403":
          description: Insufficient permissions (only citizens can create reports)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Only citizens can create reports"
        "413":
          description: Photo file(s) too large
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 413
                error: "PayloadTooLarge"
                message: "One or more photos exceed the maximum file size"
        "422":
          description: Invalid coordinates (outside Turin municipality boundaries)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 422
                error: "UnprocessableEntity"
                message: "Coordinates are outside Turin municipality boundaries"
        "500":
          description: Unable to create report
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "Unable to create report"
    get:
      tags:
        - Reports
      summary: Get all approved reports for map visualization
      description: |
        Retrieve all approved reports for display on an interactive map. This endpoint returns only reports 
        that have been approved by public relations officers and are in one of the following statuses:
        - ASSIGNED (approved and assigned to technical staff)
        - EXTERNAL_ASSIGNED (assigned to external company/maintainer)
        - IN_PROGRESS (being worked on)
        - RESOLVED (completed)

        Reports with status PENDING_APPROVAL or REJECTED are NOT included in the response.

        This endpoint is designed for citizen-facing map views where users can see all active and resolved 
        issues in their area. The response includes reporter information (name or "anonymous" flag), location 
        coordinates, and other details needed for map markers and popups.

        Optionally filter by a bounding box using the `bbox` query parameter in the format 
        `minLon,minLat,maxLon,maxLat` (decimal degrees, WGS84). This is useful for map views where the 
        frontend requests only reports within the currently visible map area.

        The `category` query parameter is also optional and can be combined with `bbox` to request
        reports of a given category inside the visible map area (e.g. `?bbox=7.66,45.06,7.70,45.08&category=PUBLIC_LIGHTING`).
      operationId: listReports
      parameters:
        - name: category
          in: query
          required: false
          description: Filter reports by category
          schema:
            $ref: "#/components/schemas/ReportCategory"
          example: ROADS_URBAN_FURNISHINGS
      responses:
        "200":
          description: Array of reports
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ReportResponse"
              example:
                - id: 1024
                  title: "Pothole on Via Roma"
                  description: "Large pothole near the pedestrian crossing, causing risk for cyclists."
                  category: ROADS_URBAN_FURNISHINGS
                  latitude: 45.070339
                  longitude: 7.686864
                  status: ASSIGNED
                  user:
                    id: 201
                    firstName: Mario
                    lastName: Rossi
                    email: mario.rossi@example.com
                    role: CITIZEN
                    telegramUsername: null
                    emailNotificationsEnabled: true
                  assignedOfficer:
                    id: 305
                    firstName: Luca
                    lastName: Verdi
                    email: luca.verdi@municipality.com
                    role: TECHNICAL_OFFICE
                  messages:
                    - id: 1
                      content: "Initial report created by user"
                      createdAt: "2025-11-11T10:12:34Z"
                      senderId: 201
                      senderRole: CITIZEN
                    - id: 2
                      content: "Report approved by public relations officer"
                      createdAt: "2025-11-11T11:15:00Z"
                      senderId: 123
                      senderRole: PUBLIC_RELATIONS
                  rejectedReason: null
                  photos:
                    - id: 301
                      url: "https://cdn.example.com/reports/1024/photo1.jpg"
                      filename: "photo1.jpg"
                  createdAt: "2025-11-11T10:12:34Z"
                  updatedAt: "2025-11-11T10:12:34Z"
                  
                - id: 1025
                  title: "Broken street light"
                  description: "Street light not working"
                  category: PUBLIC_LIGHTING
                  latitude: 45.071000
                  longitude: 7.687500
                  status: RESOLVED
                  user:
                    id: 202
                    firstName: Maria
                    lastName: Bianchi
                    email: maria.bianchi@example.com
                    role: CITIZEN
                    telegramUsername: null
                    emailNotificationsEnabled: true
                  assignedOfficer:
                    id: 306
                    firstName: Paolo
                    lastName: Neri
                    email: paolo.neri@municipality.com
                    role: TECHNICAL_OFFICE
                  messages: []
                  rejectedReason: null
                  photos: []
                  createdAt: "2025-11-10T09:00:00Z"
                  updatedAt: "2025-11-12T08:00:00Z"
                  
        "400":
          description: Invalid category parameter
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 400
                error: "BadRequest"
                message: "Invalid category value"
        "500":
          description: Unable to retrieve reports
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "Error during report retrieval"

  /reports/pending:
    get:
      tags:
        - Reports
      summary: Get reports pending approval
      description: |
        Retrieve all reports with status PENDING for review by PUBLIC_RELATIONS officers.
        This is a specialized endpoint for PUBLIC_RELATIONS staff only to review and process citizen reports.
        Only PUBLIC_RELATIONS can approve, reject, or assign reports to technical staff.
        Technical staff and external maintainers cannot access pending reports.
      operationId: getPendingReports
      security:
        - SessionAuth: []
      responses:
        "200":
          description: List of pending reports retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ReportResponse"
              example:
                - id: 1024
                  title: "Pothole on Via Roma"
                  description: "Large pothole near the pedestrian crossing, causing risk for cyclists."
                  category: ROADS_URBAN_FURNISHINGS
                  latitude: 45.070339
                  longitude: 7.686864
                  status: PENDING_APPROVAL
                  user:
                    id: 201
                    firstName: Mario
                    lastName: Rossi
                    email: mario.rossi@example.com
                    role: CITIZEN
                    telegramUsername: null
                    emailNotificationsEnabled: true
                  assignedOfficer: null
                  messages:
                    - id: 1
                      content: "Initial report created by user"
                      createdAt: "2025-11-11T10:12:34Z"
                      senderId: 201
                  rejectedReason: null
                  photos:
                    - id: 301
                      url: "https://cdn.example.com/reports/1024/photo1.jpg"
                      filename: "photo1.jpg"
                  createdAt: "2025-11-11T10:12:34Z"
                  updatedAt: "2025-11-11T10:12:34Z"
                  
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions (PUBLIC_RELATIONS role required)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Public relations officer privileges required"
        "500":
          description: Unable to retrieve pending reports
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "Failed to retrieve pending reports"

  /reports/{reportId}/assignable-technicals:
    get:
      tags:
        - Reports
      summary: List technicals available for this report's category
      description: |
        Return the list of municipality technical users (TECHNICAL_ROLES) that are valid assignees for the given report.
        The backend filters available technicals according to the report's category. This endpoint is
        intended for use by PUBLIC_RELATIONS officers only when approving a report and choosing the responsible technical.
        External maintainers cannot access this endpoint as they cannot approve reports.
      operationId: getAssignableTechnicals
      security:
        - SessionAuth: []
      parameters:
        - name: reportId
          in: path
          required: true
          description: ID of the report
          schema:
            type: integer
            format: int64
      responses:
        "200":
          description: Array of municipality technical users suitable for assignment
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MunicipalityUserResponse"
              example:
                - id: 305
                  firstName: Luca
                  lastName: Verdi
                  email: luca.verdi@municipality.com
                  role: MUNICIPAL_BUILDING_MAINTENANCE
                - id: 306
                  firstName: Paolo
                  lastName: Neri
                  email: paolo.neri@municipality.com
                  role: ROAD_MAINTENANCE
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions (PUBLIC_RELATIONS role required)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Public relations officer privileges required"
        "404":
          description: Report not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 404
                error: "NotFound"
                message: "Report not found"
        "500":
          description: Unable to retrieve technicals
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "Failed to retrieve assignable technicals"

  /reports/{reportId}/assignable-externals:
    get:
      tags:
        - Reports
      summary: List external companies and maintainers available for this report's category
      description: |
        Return the list of external companies and their maintainer users that can handle the given report.
        The backend filters available external companies according to the report's category (e.g., Enel X for PUBLIC_LIGHTING).
        
        Returns two types of assignees:
        - **Users**: For companies with platform access (has_platform_access=true), returns individual maintainer users
        - **Companies**: For companies without platform access (has_platform_access=false), returns only company information
        
        This endpoint is intended for use by municipality TECHNICAL_ROLES staff members when they need to assign a report to an external entity.
        External maintainers cannot access this endpoint as they cannot assign reports to other externals.
      operationId: getAssignableExternals
      security:
        - SessionAuth: []
      parameters:
        - name: reportId
          in: path
          required: true
          description: ID of the report
          schema:
            type: integer
            format: int64
      responses:
        "200":
          description: Array of external companies that can handle this report category
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ExternalCompanyResponse"
              example:
                - id: 10
                  name: Enel X
                  categories:
                    - PUBLIC_LIGHTING
                  platformAccess: true
                  users:
                    - id: 501
                      firstName: Marco
                      lastName: Bianchi
                      email: marco.bianchi@enelx.com
                      role: EXTERNAL_MAINTAINER
                    - id: 502
                      firstName: Giulia
                      lastName: Ferrari
                      email: giulia.ferrari@enelx.com
                      role: EXTERNAL_MAINTAINER
                - id: 11
                  name: AMIAT Torino
                  categories:
                    - WASTE
                    - ROADS_URBAN_FURNISHINGS
                  platformAccess: false
                  users: null
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions (must be assigned technical officer)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                notTechnicalStaff:
                  summary: User does not have technical staff role
                  value:
                    code: 403
                    error: "Forbidden"
                    message: "Technical office staff privileges required"
                notAssignedOfficer:
                  summary: User is not the assigned technical officer for this report
                  value:
                    code: 403
                    error: "Forbidden"
                    message: "Only the assigned technical officer can view assignable externals"
        "404":
          description: Report not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 404
                error: "NotFound"
                message: "Report not found"
        "500":
          description: Unable to retrieve external maintainers
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "Failed to retrieve assignable external maintainers"

  /reports/{reportId}/assign-external:
    post:
      tags:
        - Reports
      summary: Assign a report to an external maintainer or company
      description: |
        Assign a report to an external entity for specialized intervention.
        Only technical office staff members can perform this operation.
        The report status changes from PENDING_APPROVAL or ASSIGNED to EXTERNAL_ASSIGNED when assigned to external entities.
        External assignment creates a specialized workflow for external company maintenance.
        
        **Assignment logic based on company platform access:**
        
        - **Companies WITH platform access** (platformAccess=true):
          - Technical officer selects a specific maintainer user from the company
          - Request must include `externalMaintainerId`
          - The selected user can log into Participium and manage the report directly
          - User can update status to IN_PROGRESS and eventually RESOLVED
        
        - **Companies WITHOUT platform access** (platformAccess=false):
          - Technical officer assigns to the company as a whole
          - Request must include `externalCompanyId`
          - Company handles intervention outside the platform
          - Technical officer manually updates the report when work is completed
        
        External maintainers and technical office can exchange internal comments on the report (not visible to citizens).
      operationId: assignReportToExternal
      security:
        - SessionAuth: []
      parameters:
        - name: reportId
          in: path
          required: true
          description: ID of the report to assign
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AssignExternalRequest"
            examples:
              assignToUserWithAccess:
                summary: Assign to company WITH platform access (specific user required)
                value:
                  externalCompanyId: 10
                  externalMaintainerId: 501
              assignToCompanyWithoutAccess:
                summary: Assign to company WITHOUT platform access (no specific user)
                value:
                  externalCompanyId: 11
                  externalMaintainerId: null
      responses:
        "200":
          description: Report assigned to external maintainer successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  report:
                    $ref: "#/components/schemas/ReportResponse"
              examples:
                userAssignment:
                  summary: Assigned to external maintainer user
                  value:
                    message: "Report assigned to external maintainer successfully"
                    report:
                      id: 1024
                      title: "Non-functioning streetlight on Via Roma"
                      description: "The streetlight at the corner of Via Roma is not working, creating safety issues at night."
                      category: PUBLIC_LIGHTING
                      latitude: 45.070339
                      longitude: 7.686864
                      status: ASSIGNED
                      user:
                        id: 201
                        firstName: Mario
                        lastName: Rossi
                        email: mario.rossi@example.com
                        role: CITIZEN
                        telegramUsername: null
                        emailNotificationsEnabled: true
                      assignedOfficer:
                        id: 305
                        firstName: Luca
                        lastName: Verdi
                        email: luca.verdi@municipality.com
                        role: MUNICIPAL_BUILDING_MAINTENANCE
                      externalHandler:
                        type: user
                        user:
                          id: 501
                          firstName: Marco
                          lastName: Bianchi
                          email: marco.bianchi@enelx.com
                          role: EXTERNAL_MAINTAINER
                          company:
                            id: 10
                            name: Enel X
                            categories:
                              - PUBLIC_LIGHTING
                            platformAccess: true
                      
                companyAssignment:
                  summary: Assigned to external company
                  value:
                    message: "Report assigned to external company successfully"
                    report:
                      id: 1025
                      title: "Waste collection overflow"
                      description: "Overflowing bins in Piazza Castello."
                      category: WASTE
                      latitude: 45.073
                      longitude: 7.687
                      status: ASSIGNED
                      user:
                        id: 202
                        firstName: Maria
                        lastName: Bianchi
                        email: maria.bianchi@example.com
                        role: CITIZEN
                        telegramUsername: null
                        emailNotificationsEnabled: true
                      assignedOfficer:
                        id: 306
                        firstName: Paolo
                        lastName: Neri
                        email: paolo.neri@municipality.com
                        role: MUNICIPAL_BUILDING_MAINTENANCE
                      externalHandler:
                        type: company
                        company:
                          id: 11
                          name: AMIAT Torino
                          categories:
                            - WASTE
                            - ROADS_URBAN_FURNISHINGS
                          platformAccess: false
                      
                  
        "400":
          description: Invalid request or report not in appropriate status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                invalidStatus:
                  summary: Report not in correct status
                  value:
                    code: 400
                    error: "BadRequest"
                    message: "Report must be in ASSIGNED status to assign to external maintainer"
                missingMaintainerId:
                  summary: Company has platform access but no maintainer ID provided
                  value:
                    code: 400
                    error: "BadRequest"
                    message: "externalMaintainerId is required when company has platform access"
                unexpectedMaintainerId:
                  summary: Company has no platform access but maintainer ID provided
                  value:
                    code: 400
                    error: "BadRequest"
                    message: "externalMaintainerId must be null when company does not have platform access"
                userNotFound:
                  summary: User not found
                  value:
                    code: 400
                    error: "BadRequest"
                    message: "User not found"
                notExternalMaintainer:
                  summary: User is not an external maintainer
                  value:
                    code: 400
                    error: "BadRequest"
                    message: "User is not an external maintainer"
                maintainerNotInCompany:
                  summary: Maintainer does not belong to specified company
                  value:
                    code: 400
                    error: "BadRequest"
                    message: "External maintainer does not belong to the specified company"
                alreadyAssignedToExternal:
                  summary: Report is already assigned to an external entity
                  value:
                    code: 400
                    error: "BadRequest"
                    message: "Report is already assigned to an external entity"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions (must be assigned technical officer)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                notTechnicalStaff:
                  summary: User does not have technical staff role
                  value:
                    code: 403
                    error: "Forbidden"
                    message: "Technical office staff privileges required"
                notAssignedOfficer:
                  summary: User is not the assigned technical officer for this report
                  value:
                    code: 403
                    error: "Forbidden"
                    message: "Only the assigned technical officer can assign to external maintainers"
        "404":
          description: Report or external maintainer not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 404
                error: "NotFound"
                message: "External maintainer not found"
        "500":
          description: Unable to assign report to external maintainer
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "Failed to assign report to external maintainer"

  /reports/{reportId}/approve:
    post:
      tags:
        - Reports
      summary: Approve a report
      description: |
        Approve a report for processing by municipality staff. Only public relations officers can perform this operation.
        The public relations officer must select a municipality technical user to assign the report to.
        The report status changes from PENDING_APPROVAL to ASSIGNED and the chosen technical user is stored as the assigned officer.
      operationId: approveReport
      security:
        - SessionAuth: []
      parameters:
        - name: reportId
          in: path
          required: true
          description: ID of the report to approve
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - assignedTechnicalId
              properties:
                assignedTechnicalId:
                  type: integer
                  format: int64
                  description: ID of the municipality technical user to assign to the report
            example:
              assignedTechnicalId: 305
      responses:
        "200":
          description: Report approved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  report:
                    $ref: "#/components/schemas/ReportResponse"
              example:
                message: "Report approved and assigned successfully"
                report:
                  id: 1024
                  title: "Pothole on Via Roma"
                  description: "Large pothole near the pedestrian crossing, causing risk for cyclists."
                  category: ROADS_URBAN_FURNISHINGS
                  latitude: 45.070339
                  longitude: 7.686864
                  status: ASSIGNED
                  user:
                    id: 201
                    firstName: Mario
                    lastName: Rossi
                    email: mario.rossi@example.com
                    role: CITIZEN
                    telegramUsername: null
                    emailNotificationsEnabled: true
                  assignedOfficer:
                    id: 305
                    firstName: Luca
                    lastName: Verdi
                    email: luca.verdi@municipality.com
                    role: MUNICIPAL_BUILDING_MAINTENANCE
                  messages:
                    - id: 1
                      content: "Initial report created by user"
                      createdAt: "2025-11-11T10:12:34Z"
                      senderId: 201
                      senderRole: CITIZEN
                    - id: 2
                      content: "Report approved and assigned by public relations officer"
                      createdAt: "2025-11-11T11:15:00Z"
                      senderId: 123
                      senderRole: PUBLIC_RELATIONS
                  rejectedReason: null
                  photos:
                    - id: 301
                      url: "https://cdn.example.com/reports/1024/photo1.jpg"
                      filename: "photo1.jpg"
                  createdAt: "2025-11-11T10:12:34Z"
                  updatedAt: "2025-11-11T11:15:00Z"
                  
        "400":
          description: Invalid report ID or report not in PENDING_APPROVAL status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 400
                error: "BadRequest"
                message: "Report is not in PENDING_APPROVAL status"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions (PUBLIC_RELATIONS role required)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Public relations officer privileges required"
        "404":
          description: Report not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 404
                error: "NotFound"
                message: "Report not found"
        "409":
          description: Report already processed by another officer
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 409
                error: "Conflict"
                message: "Report has already been processed"
        "500":
          description: Unable to approve report
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "Failed to approve report"

  /reports/{reportId}/reject:
    post:
      tags:
        - Reports
      summary: Reject a report
      description: |
        Reject a report with a mandatory explanation. Only public relations officers can perform this operation.
        The report status changes from PENDING_APPROVAL to REJECTED.
        A rejection reason must be provided in the request body.
      operationId: rejectReport
      security:
        - SessionAuth: []
      parameters:
        - name: reportId
          in: path
          required: true
          description: ID of the report to reject
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RejectReportRequest"
            example:
              reason: "The reported issue does not fall under municipal jurisdiction"
      responses:
        "200":
          description: Report rejected successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  report:
                    $ref: "#/components/schemas/ReportResponse"
              example:
                message: "Report rejected successfully"
                report:
                  id: 1024
                  title: "Pothole on Via Roma"
                  description: "Large pothole near the pedestrian crossing, causing risk for cyclists."
                  category: ROADS_URBAN_FURNISHINGS
                  latitude: 45.070339
                  longitude: 7.686864
                  status: REJECTED
                  user:
                    id: 201
                    firstName: Mario
                    lastName: Rossi
                    email: mario.rossi@example.com
                    role: CITIZEN
                    telegramUsername: null
                    emailNotificationsEnabled: true
                  assignedOfficer: null
                  messages:
                    - id: 1
                      content: "Initial report created by user"
                      createdAt: "2025-11-11T10:12:34Z"
                      senderId: 201
                    - id: 2
                      content: "Report rejected by public relations officer"
                      createdAt: "2025-11-11T11:15:00Z"
                      senderId: 123
                  rejectedReason: "The reported issue does not fall under municipal jurisdiction"
                  photos:
                    - id: 301
                      url: "https://cdn.example.com/reports/1024/photo1.jpg"
                      filename: "photo1.jpg"
                  createdAt: "2025-11-11T10:12:34Z"
                  updatedAt: "2025-11-11T11:15:00Z"
                  
        "400":
          description: Invalid report ID, missing rejection reason, or report not in PENDING_APPROVAL status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 400
                error: "BadRequest"
                message: "Missing required field: reason"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions (PUBLIC_RELATIONS role required)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Public relations officer privileges required"
        "404":
          description: Report not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 404
                error: "NotFound"
                message: "Report not found"
        "409":
          description: Report already processed by another officer
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 409
                error: "Conflict"
                message: "Report has already been processed"
        "422":
          description: Invalid rejection reason (empty, too long, or inappropriate content)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 422
                error: "UnprocessableEntity"
                message: "Rejection reason must be between 1 and 500 characters"
        "500":
          description: Unable to reject report
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "Failed to reject report"

  /reports/assigned:
    get:
      tags:
        - Reports
      summary: Get reports assigned to the authenticated technical officer
      description: |
        Retrieve all reports assigned to the authenticated technical officer or external maintainer.
        Available for TECHNICAL_AND_EXTERNAL_ROLES (both municipality technical staff and external maintainers).
        Returns reports with status ASSIGNED, EXTERNAL_ASSIGNED, IN_PROGRESS, or RESOLVED that are assigned to the current user.
        
        For internal staff: filters by assignedOfficerId
        For external maintainers: filters by externalMaintainerId
        The user ID is extracted from the session token, ensuring users can only see their own assigned reports.

        Optional query parameters allow filtering by status and sorting the results.
      operationId: getAssignedReports
      security:
        - SessionAuth: []
      parameters:
        - name: status
          in: query
          required: false
          description: Filter reports by status
          schema:
            type: string
            enum:
              - ASSIGNED
              - EXTERNAL_ASSIGNED
              - IN_PROGRESS
              - RESOLVED
          example: ASSIGNED
        - name: sortBy
          in: query
          required: false
          description: Field to sort by
          schema:
            type: string
            enum:
              - createdAt
              - priority
          example: createdAt
        - name: order
          in: query
          required: false
          description: Sort order
          schema:
            type: string
            enum:
              - asc
              - desc
          example: desc
      responses:
        "200":
          description: List of assigned reports retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ReportResponse"
              example:
                - id: 1024
                  title: "Pothole on Via Roma"
                  description: "Large pothole near the pedestrian crossing, causing risk for cyclists."
                  category: ROADS_URBAN_FURNISHINGS
                  latitude: 45.070339
                  longitude: 7.686864
                  status: ASSIGNED
                  user:
                    id: 201
                    firstName: Mario
                    lastName: Rossi
                    email: mario.rossi@example.com
                    role: CITIZEN
                    telegramUsername: null
                    emailNotificationsEnabled: true
                  assignedOfficer:
                    id: 305
                    firstName: Luca
                    lastName: Verdi
                    email: luca.verdi@municipality.com
                    role: TECHNICAL_OFFICE
                  messages:
                    - id: 1
                      content: "Initial report created by user"
                      createdAt: "2025-11-11T10:12:34Z"
                      senderId: 201
                    - id: 2
                      content: "Report assigned to technical staff"
                      createdAt: "2025-11-12T09:00:00Z"
                      senderId: 300
                  rejectedReason: null
                  photos:
                    - id: 301
                      url: "https://cdn.example.com/reports/1024/photo1.jpg"
                      filename: "photo1.jpg"
                  createdAt: "2025-11-11T10:12:34Z"
                  updatedAt: "2025-11-12T09:00:00Z"
                  
                - id: 1026
                  title: "Broken street light"
                  description: "Street light not working on Via Torino"
                  category: PUBLIC_LIGHTING
                  latitude: 45.071
                  longitude: 7.6875
                  status: IN_PROGRESS
                  user:
                    id: 202
                    firstName: Maria
                    lastName: Bianchi
                    email: maria.bianchi@example.com
                    role: CITIZEN
                    telegramUsername: null
                    emailNotificationsEnabled: true
                  assignedOfficer:
                    id: 305
                    firstName: Luca
                    lastName: Verdi
                    email: luca.verdi@municipality.com
                    role: TECHNICAL_OFFICE
                  messages:
                    - id: 3
                      content: "Initial report created by user"
                      createdAt: "2025-11-10T09:00:00Z"
                      senderId: 202
                    - id: 4
                      content: "Started maintenance work"
                      createdAt: "2025-11-13T10:30:00Z"
                      senderId: 305
                  rejectedReason: null
                  photos: []
                  createdAt: "2025-11-10T09:00:00Z"
                  updatedAt: "2025-11-13T10:30:00Z"
                  
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions (Technical office role required)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Technical office staff privileges required"
        "500":
          description: Unable to retrieve assigned reports
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "Failed to retrieve assigned reports"

  /reports/{reportId}/status:
    patch:
      tags:
        - Reports
      summary: Update report status
      description: |
        Update the status of an assigned report. Available for TECHNICAL_AND_EXTERNAL_ROLES.
        Only technical staff or external maintainers assigned to the report can perform this operation.
        Valid status transitions:
        - ASSIGNED  IN_PROGRESS
        - IN_PROGRESS  RESOLVED
        - IN_PROGRESS  SUSPENDED
        - SUSPENDED  IN_PROGRESS
        
        A notification is automatically created for the citizen when the status changes.
      operationId: updateReportStatus
      security:
        - SessionAuth: []
      parameters:
        - name: reportId
          in: path
          required: true
          description: ID of the report to update
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - status
              properties:
                status:
                  type: string
                  enum:
                    - IN_PROGRESS
                    - SUSPENDED
                    - RESOLVED
                  description: New status for the report
                note:
                  type: string
                  maxLength: 500
                  description: Optional note explaining the status change
            example:
              status: "IN_PROGRESS"
              note: "Started maintenance work on the reported issue"
      responses:
        "200":
          description: Status updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  report:
                    $ref: "#/components/schemas/ReportResponse"
        "400":
          description: Invalid status transition or missing required fields
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Report not assigned to current user or insufficient permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Report not assigned to current user or insufficient permissions"
        "404":
          description: Report not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 404
                error: "NotFound"
                message: "Report not found"
        "500":
          description: Unable to update status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "Unable to update status"

  /reports/{reportId}/messages:
    post:
      tags:
        - Reports
      summary: Send message to citizen
      description: |
        Send a message to the citizen who created the report. Available for TECHNICAL_AND_EXTERNAL_ROLES.
        Only technical staff or external maintainers assigned to the report can send messages.
        A notification is automatically created for the citizen.
      operationId: sendReportMessage
      security:
        - SessionAuth: []
      parameters:
        - name: reportId
          in: path
          required: true
          description: ID of the report
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - content
              properties:
                content:
                  type: string
                  minLength: 1
                  maxLength: 1000
                  description: Message content
            example:
              content: "We are working on resolving the issue. Expected completion by Friday."
      responses:
        "201":
          description: Message sent successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  data:
                    $ref: "#/components/schemas/ReportMessage"
        "400":
          description: Missing or invalid content
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 400
                error: "BadRequest"
                message: "Missing or invalid content"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Report not assigned to user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Report not assigned to user"
        "404":
          description: Report not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 404
                error: "NotFound"
                message: "Report not found"
        "500":
          description: Unable to send message
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "Unable to send message"

    get:
      tags:
        - Reports
      summary: Get report conversation history
      description: |
        Retrieve all messages for a specific report. Citizens can access their own reports,
        technical staff and external maintainers can access conversations for their assigned reports.
      operationId: getReportMessages
      security:
        - SessionAuth: []
      parameters:
        - name: reportId
          in: path
          required: true
          description: ID of the report
          schema:
            type: integer
            format: int64
      responses:
        "200":
          description: Messages retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ReportMessage"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Not authorized to view this conversation
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Not authorized to view this conversation"
        "404":
          description: Report not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 404
                error: "NotFound"
                message: "Report not found"
        "500":
          description: Unable to retrieve messages
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "Unable to retrieve messages"

  /notifications:
    get:
      tags:
        - Notifications
      summary: Get user notifications
      description: |
        Retrieve all notifications for the authenticated user. 
        Frontend should poll this endpoint every 30-60 seconds to check for new notifications.
        
        Notifications are generated when:
        - Report status changes (for citizens)
        - New messages are received (for citizens)
        - Reports are assigned (for technical staff)
        - Reports are approved/rejected (for citizens)
      operationId: getNotifications
      security:
        - SessionAuth: []
      parameters:
        - name: unreadOnly
          in: query
          required: false
          schema:
            type: boolean
            default: false
          description: Return only unread notifications
        - name: limit
          in: query
          required: false
          schema:
            type: integer
            default: 50
            maximum: 100
          description: Maximum number of notifications to return
      responses:
        "200":
          description: List of notifications
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Notification"
              example:
                - id: 501
                  type: "REPORT_STATUS_CHANGED"
                  title: "Report status updated"
                  message: "Your report 'Pothole on Via Roma' is now IN_PROGRESS"
                  reportId: 1024
                  read: false
                  createdAt: "2025-11-24T14:30:00Z"
                - id: 502
                  type: "MESSAGE_RECEIVED"
                  title: "New message on your report"
                  message: "Technical staff sent you a message about 'Pothole on Via Roma'"
                  reportId: 1024
                  read: false
                  createdAt: "2025-11-24T15:00:00Z"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "500":
          description: Unable to retrieve notifications
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "Unable to retrieve notifications"

  /notifications/{notificationId}/read:
    patch:
      tags:
        - Notifications
      summary: Mark notification as read
      operationId: markNotificationAsRead
      security:
        - SessionAuth: []
      parameters:
        - name: notificationId
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        "200":
          description: Notification marked as read
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Notification marked as read"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Not authorized to modify this notification
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Not authorized to modify this notification"
        "404":
          description: Notification not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 404
                error: "NotFound"
                message: "Notification not found"

  /reports/{reportId}:
    get:
      tags:
        - Reports
      summary: Get single report details
      description: |
        Retrieve detailed information about a specific report including all messages.
        - Citizens can only view their own reports
        - Technical staff and external maintainers can view reports assigned to them
        - Public relations can view any report
      operationId: getReportById
      security:
        - SessionAuth: []
      parameters:
        - name: reportId
          in: path
          required: true
          description: ID of the report
          schema:
            type: integer
            format: int64
      responses:
        "200":
          description: Report details retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ReportResponse"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 401
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Not authorized to view this report
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 403
                error: "Forbidden"
                message: "Not authorized to view this report"
        "404":
          description: Report not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 404
                error: "NotFound"
                message: "Report not found"
        "500":
          description: Unable to retrieve report
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                code: 500
                error: "InternalServerError"
                message: "Unable to retrieve report"

components:
  securitySchemes:
    SessionAuth:
      type: apiKey
      in: cookie
      name: connect.sid
      description: |
        Session-based authentication using HTTP-only cookies with Passport.js.
        The session cookie is automatically sent by the browser with each request.
        Frontend must use 'credentials: include' in fetch/axios requests.

  schemas:
    CitizenRegistrationRequest:
      type: object
      required:
        - firstName
        - lastName
        - email
        - password
      properties:
        firstName:
          type: string
          minLength: 1
          maxLength: 50
          description: Citizen's first name
          example: Mario
        lastName:
          type: string
          minLength: 1
          maxLength: 50
          description: Citizen's last name
          example: Rossi
        email:
          type: string
          format: email
          maxLength: 100
          description: Valid email address (must be unique)
          example: mario.rossi@example.com
        password:
          type: string
          minLength: 8
          maxLength: 100
          format: password
          description: Password (minimum 8 characters)
          example: SecurePass123!

    CitizenRegistrationResponse:
      $ref: "#/components/schemas/UserInfo"

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          description: User's email address
          example: mario.rossi@example.com
        password:
          type: string
          format: password
          description: Password
          example: SecurePass123!

    LoginResponse:
      type: object
      properties:
        message:
          type: string
          example: "Login successful"
        user:
          $ref: "#/components/schemas/UserInfo"
    VerifyRequest:
      type: object
      required:
        - email
        - code
      properties:
        email:
          type: string
          format: email
          example: mario.rossi@example.com
        code:
          type: string
          description: The 6-digit verification code sent via email
          minLength: 6
          maxLength: 6
          example: "123456"

    SessionResponse:
      type: object
      required:
        - authenticated
      properties:
        authenticated:
          type: boolean
          description: Whether the user is authenticated
          example: true
        user:
          allOf:
            - $ref: "#/components/schemas/UserInfo"
          description: User information

    UserInfo:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: User ID
          example: 201
        firstName:
          type: string
          example: Mario
        lastName:
          type: string
          example: Rossi
        email:
          type: string
          example: mario.rossi@example.com
        role:
          $ref: "#/components/schemas/UserRole"
        telegramUsername:
          type: string
          nullable: true
          description: Telegram username for bot notifications
          example: null
        emailNotificationsEnabled:
          type: boolean
          description: Whether email notifications are enabled
          example: true
        isVerified:
          type: boolean
          description: Whether the user's email has been verified
          example: true

    ErrorResponse:
      type: object
      required:
        - code
      properties:
        code:
          type: integer
          description: HTTP status code of the error
          example: 400
        error:
          type: string
          description: Error type (BadRequest, Unauthorized, Conflict, InternalServerError)
          example: "BadRequest"
        message:
          type: string
          description: Human-readable error message
          example: "Missing required fields: email, password"

    MunicipalityUserRequest:
      type: object
      required:
        - firstName
        - lastName
        - email
        - password
        - role
      properties:
        firstName:
          type: string
          minLength: 1
          maxLength: 50
          description: Municipality user's first name
          example: Giuseppe
        lastName:
          type: string
          minLength: 1
          maxLength: 50
          description: Municipality user's last name
          example: Verdi
        email:
          type: string
          format: email
          maxLength: 100
          description: Valid email address (must be unique)
          example: giuseppe.verdi@comune.torino.it
        password:
          type: string
          minLength: 8
          maxLength: 100
          format: password
          description: Password (minimum 8 characters)
          example: AdminPass123!
        role:
          $ref: "#/components/schemas/MunicipalityRole"

    MunicipalityUserResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Unique identifier for the user
          example: 123
        firstName:
          type: string
          example: Giuseppe
        lastName:
          type: string
          example: Verdi
        email:
          type: string
          example: giuseppe.verdi@comune.torino.it
        role:
          $ref: "#/components/schemas/MunicipalityRole"

    ExternalMaintainerResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Unique identifier for the external maintainer user
          example: 501
        firstName:
          type: string
          description: External maintainer's first name
          example: Marco
        lastName:
          type: string
          description: External maintainer's last name
          example: Bianchi
        email:
          type: string
          format: email
          description: External maintainer's email address
          example: marco.bianchi@enelx.com
        role:
          type: string
          enum:
            - EXTERNAL_MAINTAINER
          description: Role is always EXTERNAL_MAINTAINER
          example: EXTERNAL_MAINTAINER
        company:
          $ref: "#/components/schemas/ExternalCompanyResponse"

    ExternalCompanyResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Unique identifier for the external company
          example: 10
        name:
          type: string
          description: Name of the external company
          example: Enel X
        categories:
          type: array
          items:
            $ref: "#/components/schemas/ReportCategory"
          description: List of report categories this company can handle (max 2)
          minItems: 1
          maxItems: 2
          example:
            - PUBLIC_LIGHTING
        platformAccess:
          type: boolean
          description: Whether the company has access to the Participium platform
          example: true

    AssignExternalRequest:
      type: object
      required:
        - externalCompanyId
      description: |
        Request to assign a report to an external company and optionally to a specific maintainer user.
        
        **Validation rules:**
        
        - `externalCompanyId` is **always required**
        - If the company has **platform access** (platformAccess=true):
          - `externalMaintainerId` **must be provided** (not null)
          - The user must belong to the specified company
          - The user must have role EXTERNAL_MAINTAINER
        - If the company has **no platform access** (platformAccess=false):
          - `externalMaintainerId` **must be null**
        
        The backend will validate these constraints and return 400 Bad Request if violated.
      properties:
        externalCompanyId:
          type: integer
          format: int64
          description: |
            ID of the external company to assign the report to. **Always required.**
            The company must be able to handle the report's category.
          example: 10
        externalMaintainerId:
          type: integer
          format: int64
          nullable: true
          description: |
            ID of the external maintainer user to assign.
            - **Must be provided** (not null) if the company has platform access (platformAccess=true)
            - **Must be null** if the company does NOT have platform access (platformAccess=false)
            
            The user must belong to the specified company and have EXTERNAL_MAINTAINER role.
          example: 501


    MunicipalityRole:
      type: string
      description: |
        A canonical list of roles that can be assigned to municipality users. Allowed values correspond to the
        roles defined for internal municipality staff in the database schema.
      enum:
        - ADMINISTRATOR
        - PUBLIC_RELATIONS
        - CULTURE_EVENTS_TOURISM_SPORTS
        - LOCAL_PUBLIC_SERVICES
        - EDUCATION_SERVICES
        - PUBLIC_RESIDENTIAL_HOUSING
        - INFORMATION_SYSTEMS
        - MUNICIPAL_BUILDING_MAINTENANCE
        - PRIVATE_BUILDINGS
        - INFRASTRUCTURES
        - GREENSPACES_AND_ANIMAL_PROTECTION
        - WASTE_MANAGEMENT
        - ROAD_MAINTENANCE
        - CIVIL_PROTECTION

    UserRole:
      type: string
      description: |
        All possible user roles in the system, including citizens, municipality staff, and external maintainers.
        Used for authentication and session management. Values mirror the `Role` enum in the Prisma schema.
      enum:
        - CITIZEN
        - ADMINISTRATOR
        - PUBLIC_RELATIONS
        - CULTURE_EVENTS_TOURISM_SPORTS
        - LOCAL_PUBLIC_SERVICES
        - EDUCATION_SERVICES
        - PUBLIC_RESIDENTIAL_HOUSING
        - INFORMATION_SYSTEMS
        - MUNICIPAL_BUILDING_MAINTENANCE
        - PRIVATE_BUILDINGS
        - INFRASTRUCTURES
        - GREENSPACES_AND_ANIMAL_PROTECTION
        - WASTE_MANAGEMENT
        - ROAD_MAINTENANCE
        - CIVIL_PROTECTION
        - EXTERNAL_MAINTAINER
      example: CITIZEN

    AssignRoleRequest:
      type: object
      required:
        - role
      properties:
        role:
          $ref: "#/components/schemas/MunicipalityRole"
      description: Payload to assign or update a municipality user's role

    Latitude:
      type: string
      description: Latitude in decimal degrees (WGS84)
      example: 45.070339

    Longitude:
      type: string
      description: Longitude in decimal degrees (WGS84)
      example: 7.686864

    ReportRequest:
      type: object
      required:
        - title
        - description
        - category
        - latitude
        - longitude
        - photos
      properties:
        title:
          type: string
          description: Short title for the report
          example: "Pothole on Via Roma"
        description:
          type: string
          description: Detailed description of the issue
          example: "Large pothole near the pedestrian crossing, causing risk for cyclists."
        category:
          $ref: "#/components/schemas/ReportCategory"
        latitude:
          $ref: "#/components/schemas/Latitude"
        longitude:
          $ref: "#/components/schemas/Longitude"
        address:
          type: string
          nullable: true
          description: Optional human-readable address for the location
          example: "Via Roma 1, Torino"
        photos:
          type: array
          minItems: 1
          maxItems: 3
          items:
            type: string
            format: binary
          description: Up to 3 photo files (image/jpeg, image/png)

    ReportSummary:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1024
        title:
          type: string
          example: "Pothole on Via Roma"
        latitude:
          $ref: "#/components/schemas/Latitude"
        longitude:
          $ref: "#/components/schemas/Longitude"
        category:
          $ref: "#/components/schemas/ReportCategory"
        status:
          $ref: "#/components/schemas/ReportStatus"

    Photo:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 301
          description: Photo ID (0 for new uploads, actual ID after saved)
        url:
          type: string
          format: uri
          example: "https://cdn.example.com/reports/1024/photo1.jpg"
        filename:
          type: string
          example: "photo1.jpg"

    ReportMessage:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1
        content:
          type: string
          example: "Initial report created by user"
        createdAt:
          type: string
          format: date-time
          example: "2025-11-11T10:12:34Z"
        senderId:
          type: integer
          format: int64
          example: 201
        senderRole:
          $ref: "#/components/schemas/UserRole"
          description: Role of the user who sent the message
          example: CITIZEN

    ReportResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1024
        title:
          type: string
          example: "Pothole on Via Roma"
        description:
          type: string
          example: "Large pothole near the pedestrian crossing, causing risk for cyclists."
        category:
          $ref: "#/components/schemas/ReportCategory"
        latitude:
          $ref: "#/components/schemas/Latitude"
        longitude:
          $ref: "#/components/schemas/Longitude"
        status:
          $ref: "#/components/schemas/ReportStatus"
        user:
          $ref: "#/components/schemas/UserInfo"
        assignedOfficer:
          oneOf:
            - $ref: "#/components/schemas/MunicipalityUserResponse"
            - enum: [null]
          description: Details of the assigned officer (null if not assigned)
        externalHandler:
          oneOf:
            - $ref: "#/components/schemas/ExternalHandler"
            - enum: [null]
        messages:
          type: array
          items:
            $ref: "#/components/schemas/ReportMessage"
        rejectedReason:
          type: string
          nullable: true
          example: null
        photos:
          type: array
          items:
            $ref: "#/components/schemas/Photo"
        createdAt:
          type: string
          format: date-time
          example: "2025-11-11T10:12:34Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-11-11T10:12:34Z"
        
      

    ReportStatus:
      type: string
      enum:
        - PENDING_APPROVAL
        - APPROVED
        - ASSIGNED
        - EXTERNAL_ASSIGNED
        - IN_PROGRESS
        - SUSPENDED
        - REJECTED
        - RESOLVED
      example: PENDING_APPROVAL

    ReportCategory:
      type: string
      description: Category of the reported problem
      enum:
        - WATER_SUPPLY_DRINKING_WATER
        - ARCHITECTURAL_BARRIERS
        - SEWER_SYSTEM
        - PUBLIC_LIGHTING
        - WASTE
        - ROAD_SIGNS_TRAFFIC_LIGHTS
        - ROADS_URBAN_FURNISHINGS
        - PUBLIC_GREEN_AREAS_PLAYGROUNDS
        - OTHER
      example: ROADS_URBAN_FURNISHINGS

    CitizenConfigRequest:
      type: object
      description: Fields that a citizen may update in their account. All fields are optional; only provided fields will be changed.
      properties:
        firstName:
          type: string
          minLength: 0
          maxLength: 50
          description: Citizen's first name
          example: Mario
        lastName:
          type: string
          minLength: 0
          maxLength: 50
          description: Citizen's last name
          example: Rossi
        email:
          type: string
          nullable: true
          format: email
          maxLength: 100
          description: New email address (must be unique)
          example: mario.updated@example.com

        password:
          type: string
          minLength: 0
          maxLength: 100
          format: password
          description: New password (minimum 8 characters)
          example: NewSecurePass123!
        telegramUsername:
          type: string
          nullable: true
          minLength: 0
          maxLength: 32
          description: Telegram username (without @)
          example: mario_rossi
        emailNotificationsEnabled:
          type: boolean
          description: Toggle for email notifications
          example: true

    CitizenConfigResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 201
        firstName:
          type: string
          example: Mario
        lastName:
          type: string
          example: Rossi
        email:
          type: string
          example: mario.rossi@example.com
        telegramUsername:
          type: string
          nullable: true
          example: mario_rossi
        emailNotificationsEnabled:
          type: boolean
          example: true
        photoUrl:
          type: string
          format: uri
          nullable: true
          example: "https://cdn.example.com/users/201/photo.jpg"

    PhotoUploadResponse:
      type: object
      properties:
        message:
          type: string
          example: "Photo uploaded successfully"
        photo:
          $ref: "#/components/schemas/Photo"

    RejectReportRequest:
      type: object
      required:
        - reason
      properties:
        reason:
          type: string
          minLength: 1
          maxLength: 500
          description: Mandatory explanation for why the report is being rejected
          example: "The reported issue does not fall under municipal jurisdiction"

    NotificationType:
      type: string
      enum:
        - REPORT_STATUS_CHANGED
        - MESSAGE_RECEIVED
        - REPORT_ASSIGNED
        - REPORT_APPROVED
        - REPORT_REJECTED
      example: REPORT_STATUS_CHANGED

    Notification:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 501
        type:
          $ref: "#/components/schemas/NotificationType"
        title:
          type: string
          example: "Report status updated"
        message:
          type: string
          example: "Your report 'Pothole on Via Roma' is now IN_PROGRESS"
        reportId:
          type: integer
          format: int64
          nullable: true
          example: 1024
        read:
          type: boolean
          example: false
        createdAt:
          type: string
          format: date-time
          example: "2025-11-24T14:30:00Z"

    ExternalHandler:
      description: Discriminated union representing the external entity handling the report
      oneOf:
        - type: object
          properties:
            type:
              type: string
              enum: [user]
            user:
              $ref: "#/components/schemas/ExternalMaintainerResponse"
          required: [type, user]
          description: Assigned to a specific external maintainer user (company with platform access)
        - type: object
          properties:
            type:
              type: string
              enum: [company]
            company:
              $ref: "#/components/schemas/ExternalCompanyResponse"
          required: [type, company]
          description: Assigned to an external company (without platform access)
      discriminator:
        propertyName: type
