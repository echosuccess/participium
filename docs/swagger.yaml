openapi: 3.0.3
info:
  title: Participium API - Citizen Registration & Municipality Administration
  description: |
    API for citizen registration, authentication (PT01), municipality user management (PT02) and municipality users role assignment (PT03).
    Uses session-based authentication with HTTP-only cookies.

    ## Municipality User Management
    System administrators can create, update and delete internal municipality user accounts.
    The system must have at least one administrator account pre-configured in the database.

    Available municipality roles:
    - PUBLIC_RELATIONS: Public relations officer for citizen communication
    - ADMINISTRATOR: Administrative staff for report management 
    - TECHNICAL_OFFICE: Technical staff for resolving reported issues
  version: 1.1.0
  contact:
    name: Municipality of Turin
    email: support@participium.torino.it

servers:
  - url: http://localhost:4000/api
    description: Development server
  - url: https://participium.torino.it/api
    description: Production server

tags:
  - name: Authentication
    description: Login, logout and session management operations
  - name: Citizens
    description: Citizen registration operations
  - name: Administration
    description: Municipality user management operations (create, update, delete)
  - name: Reports
    description: Create and retrieve geolocated reports submitted by citizens

paths:
  /session:
    post:
      tags:
        - Authentication
      summary: Login to the system
      description: |
        Authenticate a user (citizen or municipality staff) and create a session.
        A session cookie (connect.sid) will be set in the response headers.
        The cookie is HTTP-only and secure (in production).
        Uses email and password for authentication via Passport.js local strategy.
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LoginRequest"
            example:
              email: mario.rossi@example.com
              password: SecurePass123!
      responses:
        "200":
          description: |
            Login successful. Session cookie set in Set-Cookie header.
            Client must include credentials in subsequent requests.
          headers:
            Set-Cookie:
              description: Session cookie
              schema:
                type: string
                example: connect.sid=s%3Axxx.yyy; Path=/; HttpOnly
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/LoginResponse"
        "400":
          description: Already logged in
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "BadRequest"
                message: "Already logged in"
        "401":
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Unauthorized"
                message: "Invalid username or password"
        "500":
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "InternalServerError"
                message: "An unexpected error occurred"

  /reports:
    post:
      tags:
        - Reports
      summary: Create a new report with geolocation
      description: |
        Create a new citizen report tied to a geographic location (latitude/longitude in WGS84).
        The frontend is expected to use an interactive map (OpenStreetMap-based, e.g. Leaflet.js) to allow the user
        to pick a location; the selected coordinates (decimal degrees) must be provided in the request body.
        Reports are associated with the authenticated user (session-based authentication).
      operationId: createReport
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              $ref: "#/components/schemas/ReportCreateMultipart"
            encoding:
              photos:
                contentType: image/jpeg, image/png
          application/json:
            schema:
              $ref: "#/components/schemas/ReportRequest"
            example:
              title: "Pothole on Via Roma"
              description: "Large pothole near the pedestrian crossing, causing risk for cyclists."
              category: ROADS_URBAN_FURNISHINGS
              latitude: 45.070339
              longitude: 7.686864
              address: "Via Roma 1, Torino"
              isAnonymous: false
              photos:
                - "https://cdn.example.com/reports/tmp/photo1.jpg"
      responses:
        "201":
          description: Report created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  report:
                    $ref: "#/components/schemas/ReportResponse"
              example:
                message: "Report created successfully"
                report:
                  id: 1024
                  title: "Pothole on Via Roma"
                  description: "Large pothole near the pedestrian crossing, causing risk for cyclists."
                  category: ROADS_URBAN_FURNISHINGS
                  latitude: 45.070339
                  longitude: 7.686864
                  isAnonymous: false
                  status: PENDING_APPROVAL
                  userId: 201
                  user:
                    id: 201
                    firstName: Mario
                    lastName: Rossi
                    email: mario.rossi@example.com
                    role: CITIZEN
                    telegramUsername: null
                    emailNotificationsEnabled: true
                  messages:
                    - id: 1
                      content: "Initial report created by user"
                      createdAt: "2025-11-11T10:12:34Z"
                      senderId: 201
                  rejectedReason: null
                  photos:
                    - id: 301
                      url: "https://cdn.example.com/reports/1024/photo1.jpg"
                      filename: "photo1.jpg"
                  createdAt: "2025-11-11T10:12:34Z"
                  updatedAt: "2025-11-11T10:12:34Z"
        "400":
          description: Missing required fields
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Bad Request"
                message: "Missing required fields"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Unauthorized"
                message: "User not logged in"
        "500":
          description: Unable to create report
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Internal Server Error"
                message: "Unable to create report"

    get:
      tags:
        - Reports
      summary: List reports (optionally filtered by bounding box)
      description: |
        Retrieve a list of reports. Optionally filter by a bounding box using the `bbox` query parameter
        in the format `minLon,minLat,maxLon,maxLat` (decimal degrees, WGS84). This is useful for map views
        where the frontend requests only reports within the currently visible map area.
        The `category` query parameter is also optional and can be combined with `bbox` to request
        reports of a given category inside the visible map area (e.g. `?bbox=7.66,45.06,7.70,45.08&category=PUBLIC_LIGHTING`).
      operationId: listReports
      parameters:
        - name: bbox
          in: query
          required: false
          description: Bounding box filter `minLon,minLat,maxLon,maxLat`
          schema:
            type: string
            example: "7.66,45.06,7.70,45.08"
        - name: category
          in: query
          required: false
          description: Filter reports by category (use one of the ReportCategory values). Optional and combinable with `bbox`.
          schema:
            $ref: "#/components/schemas/ReportCategory"
          example: ROADS_AND_URBAN_FURNISHINGS
      responses:
        "200":
          description: Array of reports
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/ReportResponse"
              example:
                - id: 1024
                  title: "Pothole on Via Roma"
                  description: "Large pothole near the pedestrian crossing, causing risk for cyclists."
                  category: ROADS_URBAN_FURNISHINGS
                  latitude: 45.070339
                  longitude: 7.686864
                  isAnonymous: false
                  status: PENDING_APPROVAL
                  userId: 201
                  user:
                    id: 201
                    firstName: Mario
                    lastName: Rossi
                    email: mario.rossi@example.com
                    role: CITIZEN
                    telegramUsername: null
                    emailNotificationsEnabled: true
                  messages:
                    - id: 1
                      content: "Initial report created by user"
                      createdAt: "2025-11-11T10:12:34Z"
                      senderId: 201
                  rejectedReason: null
                  photos:
                    - id: 301
                      url: "https://cdn.example.com/reports/1024/photo1.jpg"
                      filename: "photo1.jpg"
                  createdAt: "2025-11-11T10:12:34Z"
                  updatedAt: "2025-11-11T10:12:34Z"
                - id: 1025
                  title: "Broken street light"
                  description: "Street light not working"
                  category: PUBLIC_LIGHTING
                  latitude: 45.071000
                  longitude: 7.687500
                  isAnonymous: false
                  status: RESOLVED
                  userId: 202
                  user:
                    id: 202
                    firstName: Maria
                    lastName: Bianchi
                    email: maria.bianchi@example.com
                    role: CITIZEN
                    telegramUsername: null
                    emailNotificationsEnabled: true
                  messages: []
                  rejectedReason: null
                  photos: []
                  createdAt: "2025-11-10T09:00:00Z"
                  updatedAt: "2025-11-12T08:00:00Z"
        "400":
          description: Invalid query parameters (e.g. malformed bbox)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "BadRequest"
                message: "Invalid bbox parameter. Expected format: minLon,minLat,maxLon,maxLat"
        "500":
          description: Unable to retrieve reports
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "InternalServerError"
                message: "Error during report retrieval"


  /session/current:
    get:
      tags:
        - Authentication
      summary: Get current session info
      description: |
        Returns information about the current authenticated user.
        Returns 200 OK with user information when authenticated.
        Returns 401 Unauthorized when no valid session exists.
        No explicit authentication required - endpoint checks session validity.
      operationId: getSession
      responses:
        "200":
          description: User is authenticated - session info retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SessionResponse"
              example:
                authenticated: true
                user:
                  firstName: Mario
                  lastName: Rossi
                  email: mario.rossi@example.com
                  role: CITIZEN
                  telegramUsername: null
                  emailNotificationsEnabled: true
        "401":
          description: User is not authenticated - no valid session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Unauthorized"
                message: "No valid session found"

    delete:
      tags:
        - Authentication
      summary: Logout from the system
      description: |
        Invalidate the current session and clear the session cookie.
        Requires an active session.
      operationId: logout
      security:
        - SessionAuth: []
      responses:
        "200":
          description: Logout successful. Session cookie invalidated.
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Logged out"
        "400":
          description: Already logged out / No active session
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "BadRequest"
                message: "Already logged out"
        "500":
          description: Logout failed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "InternalServerError"
                message: "Logout failed"

  /citizen/signup:
    post:
      tags:
        - Citizens
      summary: Register a new citizen
      description: |
        Self-service registration for citizens. No authentication required.
        Email must be unique in the system.
      operationId: registerCitizen
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CitizenRegistrationRequest"
            example:
              firstName: Mario
              lastName: Rossi
              email: mario.rossi@example.com
              password: SecurePass123!
      responses:
        "201":
          description: Registration successful
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CitizenRegistrationResponse"
        "400":
          description: Missing required fields
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "BadRequest"
                message: "Missing required fields: email, password"
        "409":
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Conflict"
                message: "Email already in use"
        "500":
          description: Unable to create user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "InternalServerError"
                message: "Unable to create user"

  /admin/municipality-users:
    post:
      tags:
        - Administration
      summary: Create a new municipality user
      description: |
        Create a new internal municipality user account. Only administrators can perform this operation.
        Email must be unique in the system.
      operationId: createMunicipalityUser
      security:
        - SessionAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/MunicipalityUserRequest"
            example:
              firstName: Giuseppe
              lastName: Verdi
              email: giuseppe.verdi@comune.torino.it
              password: AdminPass123!
              role: PUBLIC_RELATIONS
      responses:
        "201":
          description: Municipality user created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MunicipalityUserResponse"
        "400":
          description: Missing required fields or invalid data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "BadRequest"
                message: "Missing required fields: firstName, lastName, email, password, role"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Forbidden"
                message: "Administrator privileges required"
        "409":
          description: Email already exists
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Conflict"
                message: "Email already in use"
        "500":
          description: Unable to create user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "InternalServerError"
                message: "Unable to create municipality user"

    get:
      tags:
        - Administration
      summary: List all municipality users
      description: |
        Retrieve a complete list of all municipality users (excluding citizens). 
        Returns all internal staff accounts including public relations officers, administrators, and technical office staff.
        Only administrators can perform this operation.

        The response includes basic information for each user:
        - User ID, name, email, and role
        - No sensitive information like passwords is returned
      operationId: listMunicipalityUsers
      security:
        - SessionAuth: []
      responses:
        "200":
          description: List of municipality users retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MunicipalityUserResponse"
              example:
                - id: 123
                  firstName: "Giuseppe"
                  lastName: "Verdi"
                  email: "giuseppe.verdi@comune.torino.it"
                  role: "PUBLIC_RELATIONS"
                - id: 456
                  firstName: "Maria"
                  lastName: "Rossi"
                  email: "maria.rossi@comune.torino.it"
                  role: "ADMINISTRATOR"
                - id: 789
                  firstName: "Franco"
                  lastName: "Bianchi"
                  email: "franco.bianchi@comune.torino.it"
                  role: "TECHNICAL_OFFICE"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Forbidden"
                message: "Administrator privileges required"
        "500":
          description: Unable to retrieve users
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "InternalServerError"
                message: "Failed to retrieve users"

  /admin/municipality-users/{userId}:
    get:
      tags:
        - Administration
      summary: Get municipality user details
      description: |
        Retrieve detailed information about a specific municipality user.
        Only administrators can perform this operation.
      operationId: getMunicipalityUser
      security:
        - SessionAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          description: ID of the municipality user
          schema:
            type: integer
            format: int64
      responses:
        "200":
          description: Municipality user details retrieved successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MunicipalityUserResponse"
        "400":
          description: Invalid user ID parameter
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "BadRequest"
                message: "Invalid user ID format"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Forbidden"
                message: "Administrator privileges required"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "NotFound"
                message: "Municipality user not found"
        "500":
          description: Unable to retrieve user details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "InternalServerError"
                message: "Failed to retrieve user"

    delete:
      tags:
        - Administration
      summary: Delete municipality user
      description: |
        Delete a municipality user account. This action is irreversible.
        Only administrators can perform this operation.
      operationId: deleteMunicipalityUser
      security:
        - SessionAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          description: ID of the municipality user to delete
          schema:
            type: integer
            format: int64
      responses:
        "204":
          description: Municipality user deleted successfully
        "400":
          description: Invalid user ID parameter
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "BadRequest"
                message: "Invalid user ID format"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Forbidden"
                message: "Administrator privileges required"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "NotFound"
                message: "Municipality user not found"
        "500":
          description: Unable to delete user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "InternalServerError"
                message: "Failed to delete user"

  /admin/roles:
    get:
      tags:
        - Administration
      summary: List available municipality roles
      description: |
        Returns the list of roles that can be assigned to municipality users. Useful for UI role selection and validation.
      operationId: listMunicipalityRoles
      security:
        - SessionAuth: []
      responses:
        "200":
          description: Array of available roles
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/MunicipalityRole"
              example:
                - PUBLIC_RELATIONS
                - TECHNICAL_OFFICE
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Forbidden"
                message: "Administrator privileges required"
        "500":
          description: Unable to retrieve roles
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "InternalServerError"
                message: "Failed to retrieve roles"

  /admin/municipality-users/{userId}/role:
    patch:
      tags:
        - Administration
      summary: Update the role to a municipality user
      description: |
        Update the municipality user by assigning or updating the `role` field. Only administrators can perform this operation.
        Uses patch instead of put to avoid sending the full user payload when only updating the role.
      operationId: patchMunicipalityUserRole
      security:
        - SessionAuth: []
      parameters:
        - name: userId
          in: path
          required: true
          description: ID of the municipality user to update
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AssignRoleRequest"
            example:
              role: ADMINISTRATOR
      responses:
        "200":
          description: Role assigned successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MunicipalityUserResponse"
        "400":
          description: Invalid role or userId
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "BadRequest"
                message: "Invalid role value"
        "401":
          description: Not authenticated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Unauthorized"
                message: "Authentication required"
        "403":
          description: Insufficient permissions
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "Forbidden"
                message: "Administrator privileges required"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "NotFound"
                message: "Municipality user not found"
        "500":
          description: Unable to assign role
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                error: "InternalServerError"
                message: "Failed to assign role"

components:
  securitySchemes:
    SessionAuth:
      type: apiKey
      in: cookie
      name: connect.sid
      description: |
        Session-based authentication using HTTP-only cookies with Passport.js.
        The session cookie is automatically sent by the browser with each request.
        Frontend must use 'credentials: include' in fetch/axios requests.

  schemas:
    CitizenRegistrationRequest:
      type: object
      required:
        - firstName
        - lastName
        - email
        - password
      properties:
        firstName:
          type: string
          minLength: 1
          maxLength: 50
          description: Citizen's first name
          example: Mario
        lastName:
          type: string
          minLength: 1
          maxLength: 50
          description: Citizen's last name
          example: Rossi
        email:
          type: string
          format: email
          maxLength: 100
          description: Valid email address (must be unique)
          example: mario.rossi@example.com
        password:
          type: string
          minLength: 8
          maxLength: 100
          format: password
          description: Password (minimum 8 characters)
          example: SecurePass123!

    CitizenRegistrationResponse:
      type: object
      properties:
        firstName:
          type: string
          example: Mario
        lastName:
          type: string
          example: Rossi
        email:
          type: string
          example: mario.rossi@example.com
        role:
          type: string
          enum: [CITIZEN]
          example: CITIZEN
        telegramUsername:
          type: string
          nullable: true
          description: Telegram username for bot notifications
          example: null
        emailNotificationsEnabled:
          type: boolean
          description: Whether email notifications are enabled
          example: true

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          description: User's email address
          example: mario.rossi@example.com
        password:
          type: string
          format: password
          description: Password
          example: SecurePass123!

    LoginResponse:
      type: object
      properties:
        message:
          type: string
          example: "Login successful"
        user:
          $ref: "#/components/schemas/UserInfo"

    SessionResponse:
      type: object
      required:
        - authenticated
      properties:
        authenticated:
          type: boolean
          description: Whether the user is authenticated
          example: true
        user:
          allOf:
            - $ref: "#/components/schemas/UserInfo"
          description: User information (only present when authenticated is true)
          nullable: true

    UserInfo:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 201
        firstName:
          type: string
          example: Mario
        lastName:
          type: string
          example: Rossi
        email:
          type: string
          example: mario.rossi@example.com
        role:
          $ref: "#/components/schemas/UserRole"
        telegramUsername:
          type: string
          nullable: true
          description: Telegram username for bot notifications
          example: null
        emailNotificationsEnabled:
          type: boolean
          description: Whether email notifications are enabled
          example: true

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error type or code (as returned by the backend)
          example: "BadRequest"
        message:
          type: string
          description: Human-readable error message
          example: "Missing required fields"

    MunicipalityUserRequest:
      type: object
      required:
        - firstName
        - lastName
        - email
        - password
        - role
      properties:
        firstName:
          type: string
          minLength: 1
          maxLength: 50
          description: Municipality user's first name
          example: Giuseppe
        lastName:
          type: string
          minLength: 1
          maxLength: 50
          description: Municipality user's last name
          example: Verdi
        email:
          type: string
          format: email
          maxLength: 100
          description: Valid email address (must be unique)
          example: giuseppe.verdi@comune.torino.it
        password:
          type: string
          minLength: 8
          maxLength: 100
          format: password
          description: Password (minimum 8 characters)
          example: AdminPass123!
        role:
          $ref: "#/components/schemas/MunicipalityRole"

    MunicipalityUserUpdateRequest:
      type: object
      description: |
        Partial municipality user update. At least one of the fields must be present in the body.
        Fields not present will be left unchanged. Password, if provided, will be hashed server-side.
      properties:
        firstName:
          type: string
          minLength: 1
          maxLength: 50
          description: Municipality user's first name
          example: Giuseppe
        lastName:
          type: string
          minLength: 1
          maxLength: 50
          description: Municipality user's last name
          example: Verdi
        email:
          type: string
          format: email
          maxLength: 100
          description: Valid email address (must be unique)
          example: giuseppe.verdi@comune.torino.it
        password:
          type: string
          minLength: 8
          maxLength: 100
          format: password
          description: New password (minimum 8 characters). If provided, it will be hashed server-side and not returned in the response.
          example: NewPassword123!
        role:
          $ref: "#/components/schemas/MunicipalityRole"

    MunicipalityUserResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Unique identifier for the user
          example: 123
        firstName:
          type: string
          example: Giuseppe
        lastName:
          type: string
          example: Verdi
        email:
          type: string
          example: giuseppe.verdi@comune.torino.it
        role:
          $ref: "#/components/schemas/MunicipalityRole"

    MunicipalityRole:
      type: string
      description: |
        A canonical list of roles that can be assigned to municipality users. Allowed values correspond to the
        three supported role types for municipality staff.
      enum:
        - PUBLIC_RELATIONS
        - TECHNICAL_OFFICE

    UserRole:
      type: string
      description: |
        All possible user roles in the system, including citizens and municipality staff.
        Used for authentication and session management.
      enum:
        - CITIZEN
        - PUBLIC_RELATIONS
        - ADMINISTRATOR
        - TECHNICAL_OFFICE
      example: CITIZEN

    AssignRoleRequest:
      type: object
      required:
        - role
      properties:
        role:
          $ref: "#/components/schemas/MunicipalityRole"
      description: Payload to assign or update a municipality user's role

    Location:
      type: object
      properties:
        latitude:
          type: number
          format: double
          description: Latitude in decimal degrees (WGS84)
          example: 45.070339
        longitude:
          type: number
          format: double
          description: Longitude in decimal degrees (WGS84)
          example: 7.686864

    ReportRequest:
      type: object
      required:
        - title
        - description
        - category
        - latitude
        - longitude
        - photos
      properties:
        title:
          type: string
          description: Short title for the report
          example: "Pothole on Via Roma"
        description:
          type: string
          description: Detailed description of the issue
          example: "Large pothole near the pedestrian crossing, causing risk for cyclists."
        latitude:
          $ref: "#/components/schemas/Location/properties/latitude"
        longitude:
          $ref: "#/components/schemas/Location/properties/longitude"
        address:
          type: string
          nullable: true
          description: Optional human-readable address for the location
          example: "Via Roma 1, Torino"
        photos:
          type: array
          minItems: 1
          items:
            type: string
            format: uri
          description: Array of URLs to uploaded photos (at least one required)
        category:
          $ref: "#/components/schemas/ReportCategory"
        isAnonymous:
          type: boolean
          description: Whether the report should be publicly anonymous
          example: false

    ReportCreateMultipart:
      type: object
      required:
        - title
        - description
        - category
        - latitude
        - longitude
        - photos
      properties:
        title:
          type: string
          example: "Pothole on Via Roma"
        description:
          type: string
          example: "Large pothole near the pedestrian crossing, causing risk for cyclists."
        category:
          $ref: "#/components/schemas/ReportCategory"
        latitude:
          $ref: "#/components/schemas/Location/properties/latitude"
        longitude:
          $ref: "#/components/schemas/Location/properties/longitude"
        address:
          type: string
          nullable: true
        isAnonymous:
          type: boolean
          example: false
        photos:
          type: array
          minItems: 1
          maxItems: 3
          items:
            type: string
            format: binary
          description: Up to 3 photo files (image/*)

    ReportSummary:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1024
        title:
          type: string
          example: "Pothole on Via Roma"
        latitude:
          $ref: "#/components/schemas/Location/properties/latitude"
        longitude:
          $ref: "#/components/schemas/Location/properties/longitude"
        category:
          $ref: "#/components/schemas/ReportCategory"
        status:
          $ref: "#/components/schemas/ReportStatus"

    ReportPhoto:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 301
        url:
          type: string
          format: uri
          example: "https://cdn.example.com/reports/1024/photo1.jpg"
        filename:
          type: string
          example: "photo1.jpg"

    ReportMessage:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1
        content:
          type: string
          example: "Initial report created by user"
        createdAt:
          type: string
          format: date-time
          example: "2025-11-11T10:12:34Z"
        senderId:
          type: integer
          format: int64
          example: 201

    ReportResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1024
        title:
          type: string
          example: "Pothole on Via Roma"
        description:
          type: string
          example: "Large pothole near the pedestrian crossing, causing risk for cyclists."
        category:
          $ref: "#/components/schemas/ReportCategory"
        latitude:
          $ref: "#/components/schemas/Location/properties/latitude"
        longitude:
          $ref: "#/components/schemas/Location/properties/longitude"
        isAnonymous:
          type: boolean
          example: false
        status:
          $ref: "#/components/schemas/ReportStatus"
        userId:
          type: integer
          format: int64
          example: 201
        user:
          $ref: "#/components/schemas/UserInfo"
        messages:
          type: array
          items:
            $ref: "#/components/schemas/ReportMessage"
        rejectedReason:
          type: string
          nullable: true
          example: null
        photos:
          type: array
          items:
            $ref: "#/components/schemas/ReportPhoto"
        createdAt:
          type: string
          format: date-time
          example: "2025-11-11T10:12:34Z"
        updatedAt:
          type: string
          format: date-time
          example: "2025-11-11T10:12:34Z"

    ReportStatus:
      type: string
      enum:
        - PENDING_APPROVAL
        - ASSIGNED
        - IN_PROGRESS
        - SUSPENDED
        - REJECTED
        - RESOLVED
      example: PENDING_APPROVAL
    ReportCategory:
      type: string
      description: Category of the reported problem
      enum:
        - WATER_SUPPLY_DRINKING_WATER
        - ARCHITECTURAL_BARRIERS
        - SEWER_SYSTEM
        - PUBLIC_LIGHTING
        - WASTE
        - ROAD_SIGNS_TRAFFIC_LIGHTS
        - ROADS_URBAN_FURNISHINGS
        - PUBLIC_GREEN_AREAS_PLAYGROUNDS
        - OTHER
      example: ROADS_URBAN_FURNISHINGS

# Security requirements for protected endpoints
security:
  - SessionAuth: []