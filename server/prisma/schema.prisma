generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id      Int     @id @default(autoincrement())
  email   String  @unique
  first_name    String
  last_name String
  password String
  salt     String
  role Role @default(CITIZEN)
  reports Report[]
  messages ReportMessage[]
  assignedReports Report[] @relation("AssignedReports")
  notifications Notification[]
  telegram_username String? 
  email_notifications_enabled Boolean @default(true)
  photo   CitizenPhoto?
}

model CitizenPhoto {
  id       Int    @id @default(autoincrement())
  url      String
  filename String
  userId   Int    @unique
  user     User   @relation(fields: [userId], references: [id])
}

enum Role {
  CITIZEN
  ADMINISTRATOR
  PUBLIC_RELATIONS
  CULTURE_EVENTS_TOURISM_SPORTS
  LOCAL_PUBLIC_SERVICES
  EDUCATION_SERVICES
  PUBLIC_RESIDENTIAL_HOUSING
  INFORMATION_SYSTEMS
  MUNICIPAL_BUILDING_MAINTENANCE
  PRIVATE_BUILDINGS
  INFRASTRUCTURES
  GREENSPACES_AND_ANIMAL_PROTECTION
  WASTE_MANAGEMENT
  ROAD_MAINTENANCE
  CIVIL_PROTECTION
}



model Report {
  id            Int      @id @default(autoincrement())
  title         String
  description   String
  category      ReportCategory 
  latitude      String
  longitude     String
  address       String?
  isAnonymous   Boolean @default(false)
  status        ReportStatus @default(PENDING_APPROVAL)
  user          User     @relation(fields: [userId], references: [id])
  userId        Int
  photos        ReportPhoto[]
  messages      ReportMessage[]
  notifications Notification[]
  rejectionReason String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  assignedTo    User?    @relation("AssignedReports", fields: [assignedToId], references: [id])
  assignedToId  Int?
}

enum ReportCategory {
  WATER_SUPPLY_DRINKING_WATER
  ARCHITECTURAL_BARRIERS
  SEWER_SYSTEM
  PUBLIC_LIGHTING
  WASTE
  ROAD_SIGNS_TRAFFIC_LIGHTS
  ROADS_URBAN_FURNISHINGS
  PUBLIC_GREEN_AREAS_PLAYGROUNDS
  OTHER
}

enum ReportStatus {
  PENDING_APPROVAL
  ASSIGNED
  IN_PROGRESS
  SUSPENDED
  REJECTED
  RESOLVED
}

 model ReportPhoto {
  id        Int      @id @default(autoincrement())
  url       String
  filename  String
  report    Report   @relation(fields: [reportId], references: [id])
  reportId  Int
} 

model ReportMessage {
  id        Int      @id @default(autoincrement())
  content   String
  createdAt DateTime @default(now())

  report    Report   @relation(fields: [reportId], references: [id])
  reportId  Int

  user      User     @relation(fields: [senderId], references: [id])
  senderId    Int
}

model Notification {
  id        Int      @id @default(autoincrement())
  type      NotificationType
  title     String
  message   String
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  
  report    Report?  @relation(fields: [reportId], references: [id])
  reportId  Int?
}

enum NotificationType {
  REPORT_STATUS_CHANGED
  MESSAGE_RECEIVED
  REPORT_ASSIGNED
  REPORT_APPROVED
  REPORT_REJECTED
}
